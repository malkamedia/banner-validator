<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banner Batch Validator - Malka Media Group LLC</title>
    
    <!-- Favicons from Malka Media CDN -->
    <link href="https://cdn.prod.website-files.com/63ed602b8bb6f01fe4678cd7/63f61f41d22be93246c43215_favicon-32x32.png" rel="shortcut icon" type="image/x-icon"/>
    <link href="https://cdn.prod.website-files.com/63ed602b8bb6f01fe4678cd7/63f61fc551b1bc5c6514d0a1_android-chrome-192x192.png" rel="apple-touch-icon"/>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/typo-js@1.2.1/typo.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --color-primary: #2563eb;
            --color-primary-light: #3b82f6;
            --color-success: #059669;
            --color-danger: #dc2626;
            --color-warning: #f59e0b;
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
            --font-size-xs: 0.7rem;
            --font-size-sm: 0.8rem;
            --font-size-base: 0.875rem;
            --font-size-lg: 1rem;
            --font-size-xl: 1.125rem;
            --font-size-2xl: 1.25rem;
            --space-1: 0.25rem;
            --space-2: 0.375rem;
            --space-3: 0.5rem;
            --space-4: 0.75rem;
            --space-5: 1rem;
            --space-6: 1.25rem;
            --border-radius-sm: 0.25rem;
            --border-radius: 0.375rem;
            --border-radius-lg: 0.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: var(--font-size-base);
            line-height: 1.4;
            color: var(--color-gray-800);
            background: var(--color-gray-50);
            padding: var(--space-4);
            min-height: 100vh;
        }

        .logo-container {
            max-width: 56rem;
            margin: 1rem auto 1.5rem auto;
            padding: 0;
            text-align: center;
        }

        .validator-container {
            max-width: 56rem;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--color-gray-200);
        }

        .validator-header {
            background: white;
            padding: var(--space-6) var(--space-6) var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .header-content h1 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
            letter-spacing: -0.025em;
        }

        .header-content p {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
        }

        /* Upload Section */
        .upload-section {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--color-gray-100);
        }

        .upload-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .upload-area {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--color-gray-50);
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            border-color: var(--color-primary);
            background: #f0f9ff;
        }

        .upload-area.dragging {
            border-color: var(--color-primary);
            background: #dbeafe;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-3);
            color: var(--color-gray-400);
        }

        .upload-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
        }

        .upload-subtitle {
            color: var(--color-gray-500);
            font-size: var(--font-size-sm);
        }

        input[type="file"] {
            display: none;
        }

        .file-queue {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            max-height: 300px;
            overflow-y: auto;
        }

        .queue-title {
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--color-gray-700);
            margin-bottom: var(--space-3);
        }

        .queue-empty {
            text-align: center;
            color: var(--color-gray-400);
            padding: var(--space-6) var(--space-3);
            font-size: var(--font-size-sm);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2);
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
            border: 1px solid var(--color-gray-200);
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        .status-icon {
            font-size: 1rem;
        }

        .status-pending { color: var(--color-gray-400); }
        .status-processing { color: var(--color-primary); }
        .status-complete { color: var(--color-success); }
        .status-error { color: var(--color-danger); }
        .status-warning { color: var(--color-warning); }

        /* Processing Section */
        .processing-section {
            display: none;
            padding: var(--space-6);
            text-align: center;
            border-bottom: 1px solid var(--color-gray-100);
        }

        .processing-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--space-4) 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .processing-text {
            font-size: var(--font-size-base);
            color: var(--color-gray-600);
        }

        /* Results Section */
        .results-section {
            display: none;
            padding: var(--space-5) var(--space-6);
        }

        .results-section.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .summary-card {
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-gray-200);
            text-align: center;
        }

        .summary-number {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--space-1);
        }

        .summary-label {
            font-size: var(--font-size-xs);
            color: var(--color-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-card.success .summary-number { color: var(--color-success); }
        .summary-card.warning .summary-number { color: var(--color-warning); }
        .summary-card.danger .summary-number { color: var(--color-danger); }

        /* Issues List */
        .issues-container {
            margin-top: var(--space-5);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
        }

        .issue-category {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .issue-item {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .issue-item:last-child {
            margin-bottom: 0;
        }

        .issue-banner-list {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
            margin-top: var(--space-1);
        }

        /* Typo Review */
        .typo-review-section {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            margin-top: var(--space-4);
        }

        .typo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: var(--space-3);
            border: 1px solid var(--color-warning);
        }

        .typo-item.approved {
            opacity: 0.6;
            border-color: var(--color-success);
            background: #f0fdf4;
        }

        .typo-item.rejected {
            border-color: var(--color-danger);
            background: #fef2f2;
        }

        .typo-info {
            flex: 1;
        }

        .typo-word {
            font-weight: 600;
            font-size: var(--font-size-base);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .typo-occurrence {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }

        .typo-actions {
            display: flex;
            gap: var(--space-2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-300);
        }

        .btn-sm {
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-xs);
        }

        /* Action Footer */
        .action-footer {
            padding: var(--space-5) var(--space-6);
            background: var(--color-gray-50);
            border-top: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-info {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
        }

        .footer-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-gray-300);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* No issues message */
        .no-issues {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-success);
        }

        .no-issues-icon {
            font-size: 3rem;
            margin-bottom: var(--space-3);
        }

        .no-issues-text {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .no-issues-subtext {
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
        }

        @media (max-width: 768px) {
            .upload-container {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Malka Logo -->
    <div class="logo-container">
        <svg viewBox="0 0 984 200" style="width: 180px; height: auto; display: inline-block;">
            <g fill="#1f2937">
                <path d="M184.7-0.2h24.1v200h-50.5v-91.1L104.2,179L50,108.7v91.1H-0.2v-200h23.8l80.6,105L184.7-0.2z"/>
                <path d="M374.6,199.8l-15.9-35.2h-81.4l-15.6,35.2h-52.8l97-200H330l97.3,200H374.6z M317.8,73.2l-22.7,49.9h45.7L317.8,73.2z"/>
                <path d="M477,158.3h98.4v41.4H426.8v-200H477V158.3z"/>
                <path d="M677.9,99.3l89.4,100.4h-65.8l-55.9-62.1l-16.5,17.9v44.3h-48.8v-200h48.8v84.5L704-0.2h60.4L677.9,99.3z"/>
                <path d="M931.2,199.8l-15.9-35.2h-81.4l-15.6,35.2h-52.8l97-200h24.1l97.3,200H931.2z M874.5,73.2l-22.7,49.9h45.7L874.5,73.2z"/>
            </g>
        </svg>
    </div>

    <!-- Main Container -->
    <div class="validator-container">
        <!-- Header -->
        <header class="validator-header">
            <div class="header-content">
                <h1>Banner Batch Validator</h1>
                <p>Validate multiple banners against IAB standards and check for typos</p>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-container">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📤</div>
                    <div class="upload-title">Drop banners here</div>
                    <div class="upload-subtitle">Upload 1-12 banners • JPG, PNG, GIF</div>
                    <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png,image/gif" multiple>
                </div>
                
                <div class="file-queue">
                    <div class="queue-title">File Queue</div>
                    <div id="fileQueue">
                        <div class="queue-empty">No files uploaded yet</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: var(--space-4); text-align: center;">
                <button id="processBtn" class="btn btn-primary" disabled>
                    Process Banners
                </button>
            </div>
        </section>

        <!-- Processing Section -->
        <section class="processing-section" id="processingSection">
            <div class="processing-text">
                Processing <span id="currentFile">0</span> of <span id="totalFiles">0</span> banners...
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-number" id="totalCount">0</div>
                    <div class="summary-label">Total Banners</div>
                </div>
                <div class="summary-card success">
                    <div class="summary-number" id="passCount">0</div>
                    <div class="summary-label">Passed</div>
                </div>
                <div class="summary-card warning">
                    <div class="summary-number" id="warningCount">0</div>
                    <div class="summary-label">Warnings</div>
                </div>
                <div class="summary-card danger">
                    <div class="summary-number" id="failCount">0</div>
                    <div class="summary-label">Failed</div>
                </div>
            </div>

            <div id="issuesContainer" class="issues-container">
                <!-- Issues will be dynamically inserted here -->
            </div>
        </section>

        <!-- Action Footer -->
        <div class="action-footer" id="actionFooter" style="display: none;">
            <div class="footer-info">
                Review complete
            </div>
            <div class="footer-actions">
                <button class="btn btn-outline" id="resetBtn">Start New Batch</button>
                <button class="btn btn-success" id="downloadReportBtn">📄 Download PDF Report</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let uploadedFiles = [];
        let processedBanners = [];
        let sessionMemory = {
            approvedWords: new Set(),
            rejectedWords: new Set()
        };
        let spellChecker = null;
        let tesseractWorker = null;
        
        // IAB Specifications
        const IAB_SPECS = {
            fixedSizes: [
                { name: "Billboard", width: 970, height: 250, maxKB: 250 },
                { name: "Smartphone Banner", width: 300, height: 50, maxKB: 50 },
                { name: "Smartphone Banner", width: 320, height: 50, maxKB: 50 },
                { name: "Leaderboard", width: 728, height: 90, maxKB: 150 },
                { name: "Super Leaderboard", width: 970, height: 90, maxKB: 200 },
                { name: "Portrait", width: 300, height: 1050, maxKB: 250 },
                { name: "Skyscraper", width: 160, height: 600, maxKB: 150 },
                { name: "Medium Rectangle", width: 300, height: 250, maxKB: 150 },
                { name: "Small Banner", width: 120, height: 60, maxKB: 50 },
                { name: "Mobile Interstitial", width: 640, height: 1136, maxKB: 300 },
                { name: "Mobile Interstitial", width: 750, height: 1334, maxKB: 300 },
                { name: "Mobile Interstitial", width: 1080, height: 1920, maxKB: 300 }
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeSpellChecker();
            setupEventListeners();
        });

        async function initializeSpellChecker() {
            // Load dictionary (using Typo.js with Hunspell dictionaries)
            try {
                // For production, you'd load actual dictionary files
                // For now, we'll simulate with a comprehensive word list
                const response = await fetch('https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt');
                const text = await response.text();
                const words = text.split('\n').map(w => w.trim().toLowerCase());
                
                // Create a Set for fast lookups
                spellChecker = {
                    dictionary: new Set(words),
                    check: function(word) {
                        const cleaned = word.toLowerCase().replace(/[^a-z]/g, '');
                        if (cleaned.length <= 2) return true; // Skip short words
                        if (/^\d+$/.test(word)) return true; // Skip numbers
                        if (sessionMemory.approvedWords.has(cleaned)) return true;
                        if (sessionMemory.rejectedWords.has(cleaned)) return false;
                        return this.dictionary.has(cleaned);
                    }
                };
                console.log('Spell checker initialized with', spellChecker.dictionary.size, 'words');
            } catch (error) {
                console.error('Error loading dictionary:', error);
                // Fallback to basic dictionary
                spellChecker = {
                    dictionary: new Set(['the', 'and', 'for', 'with', 'your', 'our', 'get', 'off', 'only']),
                    check: function(word) {
                        return true; // Allow everything if dictionary fails to load
                    }
                };
            }
        }

        async function initializeTesseract() {
            if (!tesseractWorker) {
                tesseractWorker = await Tesseract.createWorker({
                    logger: m => console.log(m)
                });
                await tesseractWorker.loadLanguage('eng');
                await tesseractWorker.initialize('eng');
            }
            return tesseractWorker;
        }

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const processBtn = document.getElementById('processBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadReportBtn = document.getElementById('downloadReportBtn');

            // Upload events
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragging');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragging');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragging');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            processBtn.addEventListener('click', processBatch);
            resetBtn.addEventListener('click', resetValidator);
            downloadReportBtn.addEventListener('click', generatePDFReport);
        }

        function handleFiles(files) {
            const fileArray = Array.from(files);
            const validFiles = fileArray.filter(file => {
                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                    console.log('Invalid file type:', file.name);
                    return false;
                }
                if (file.size > 10 * 1024 * 1024) {
                    console.log('File too large:', file.name);
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) {
                alert('Please upload valid image files (JPG, PNG, GIF) under 10MB');
                return;
            }

            // Add to queue
            uploadedFiles = [...uploadedFiles, ...validFiles].slice(0, 12); // Max 12 files
            updateFileQueue();
        }

        function updateFileQueue() {
            const queueEl = document.getElementById('fileQueue');
            const processBtn = document.getElementById('processBtn');

            if (uploadedFiles.length === 0) {
                queueEl.innerHTML = '<div class="queue-empty">No files uploaded yet</div>';
                processBtn.disabled = true;
            } else {
                queueEl.innerHTML = uploadedFiles.map((file, index) => `
                    <div class="file-item" data-index="${index}">
                        <div class="file-info">
                            <span>${file.name}</span>
                        </div>
                        <div class="file-status">
                            <span class="status-icon status-pending">⏸</span>
                            <span>Pending</span>
                        </div>
                    </div>
                `).join('');
                processBtn.disabled = false;
            }
        }

        async function processBatch() {
            if (uploadedFiles.length === 0) return;

            // Reset state
            processedBanners = [];
            sessionMemory = {
                approvedWords: new Set(),
                rejectedWords: new Set()
            };

            // Show processing section
            document.getElementById('processingSection').classList.add('active');
            document.getElementById('totalFiles').textContent = uploadedFiles.length;
            
            // Hide upload section buttons
            document.getElementById('processBtn').disabled = true;

            // Initialize Tesseract
            const worker = await initializeTesseract();

            // Process each file
            for (let i = 0; i < uploadedFiles.length; i++) {
                updateProgress(i + 1);
                updateFileStatus(i, 'processing');
                
                try {
                    const result = await processImage(uploadedFiles[i], worker);
                    processedBanners.push(result);
                    updateFileStatus(i, result.hasIssues ? 'warning' : 'complete');
                } catch (error) {
                    console.error('Error processing file:', uploadedFiles[i].name, error);
                    processedBanners.push({
                        file: uploadedFiles[i],
                        error: true,
                        errorMessage: error.message
                    });
                    updateFileStatus(i, 'error');
                }
            }

            // Show results
            displayResults();
        }

        function updateProgress(current) {
            document.getElementById('currentFile').textContent = current;
            const progress = (current / uploadedFiles.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function updateFileStatus(index, status) {
            const fileItem = document.querySelector(`.file-item[data-index="${index}"]`);
            if (fileItem) {
                const statusEl = fileItem.querySelector('.file-status');
                const icons = {
                    pending: '⏸',
                    processing: '<span class="spinner"></span>',
                    complete: '✓',
                    warning: '⚠',
                    error: '✗'
                };
                statusEl.innerHTML = `
                    <span class="status-icon status-${status}">${icons[status]}</span>
                    <span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `;
            }
        }

        async function processImage(file, worker) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    const img = new Image();
                    
                    img.onload = async () => {
                        const result = {
                            file: file,
                            fileName: file.name,
                            width: img.width,
                            height: img.height,
                            fileSize: file.size,
                            format: file.type.split('/')[1].toUpperCase(),
                            iabIssues: [],
                            typos: [],
                            hasIssues: false
                        };

                        // Check IAB compliance (file size first)
                        const iabMatch = IAB_SPECS.fixedSizes.find(spec => 
                            spec.width === img.width && spec.height === img.height
                        );

                        if (iabMatch) {
                            result.iabStandard = iabMatch.name;
                            const fileSizeKB = file.size / 1024;
                            
                            if (fileSizeKB > iabMatch.maxKB) {
                                result.iabIssues.push({
                                    type: 'fileSize',
                                    message: `File size (${(fileSizeKB).toFixed(1)}KB) exceeds IAB limit (${iabMatch.maxKB}KB)`
                                });
                                result.hasIssues = true;
                            }
                        } else {
                            result.iabIssues.push({
                                type: 'dimensions',
                                message: `Non-standard dimensions: ${img.width}×${img.height}px`
                            });
                            result.hasIssues = true;
                        }

                        // Only do OCR if file size check passes
                        if (!result.iabIssues.some(issue => issue.type === 'fileSize')) {
                            try {
                                const { data: { text } } = await worker.recognize(e.target.result);
                                result.extractedText = text;
                                
                                // Check for typos
                                const words = text.toLowerCase().match(/\b[a-z]+\b/g) || [];
                                const uniqueWords = [...new Set(words)];
                                
                                for (const word of uniqueWords) {
                                    if (!sessionMemory.approvedWords.has(word) && 
                                        !sessionMemory.rejectedWords.has(word) &&
                                        !spellChecker.check(word)) {
                                        result.typos.push(word);
                                        result.hasIssues = true;
                                    }
                                }
                            } catch (error) {
                                console.error('OCR error:', error);
                            }
                        }

                        resolve(result);
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            });
        }

        function displayResults() {
            // Hide processing, show results
            document.getElementById('processingSection').classList.remove('active');
            document.getElementById('resultsSection').classList.add('active');
            document.getElementById('actionFooter').style.display = 'flex';

            // Calculate summary
            const total = processedBanners.length;
            const passed = processedBanners.filter(b => !b.hasIssues && !b.error).length;
            const warnings = processedBanners.filter(b => b.hasIssues && !b.error).length;
            const failed = processedBanners.filter(b => b.error).length;

            // Update summary cards
            document.getElementById('totalCount').textContent = total;
            document.getElementById('passCount').textContent = passed;
            document.getElementById('warningCount').textContent = warnings;
            document.getElementById('failCount').textContent = failed;

            // Display issues
            const issuesContainer = document.getElementById('issuesContainer');
            
            if (warnings === 0 && failed === 0) {
                issuesContainer.innerHTML = `
                    <div class="no-issues">
                        <div class="no-issues-icon">✅</div>
                        <div class="no-issues-text">All banners passed validation!</div>
                        <div class="no-issues-subtext">No issues found in any of the ${total} banners.</div>
                    </div>
                `;
            } else {
                let html = '';

                // File size issues (priority)
                const sizeIssues = processedBanners.filter(b => 
                    b.iabIssues?.some(i => i.type === 'fileSize')
                );
                
                if (sizeIssues.length > 0) {
                    html += `
                        <div class="issue-category">
                            <div class="category-header">
                                <span class="status-icon status-error">✗</span>
                                File Size Issues (${sizeIssues.length})
                            </div>
                            ${sizeIssues.map(banner => `
                                <div class="issue-item">
                                    <strong>${banner.fileName}</strong>
                                    ${banner.iabIssues.filter(i => i.type === 'fileSize')
                                        .map(i => `<div style="margin-top: var(--space-1); color: var(--color-gray-600); font-size: var(--font-size-sm);">${i.message}</div>`)
                                        .join('')}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Dimension issues
                const dimIssues = processedBanners.filter(b => 
                    b.iabIssues?.some(i => i.type === 'dimensions')
                );
                
                if (dimIssues.length > 0) {
                    html += `
                        <div class="issue-category">
                            <div class="category-header">
                                <span class="status-icon status-warning">⚠</span>
                                Dimension Issues (${dimIssues.length})
                            </div>
                            ${dimIssues.map(banner => `
                                <div class="issue-item">
                                    <strong>${banner.fileName}</strong>
                                    ${banner.iabIssues.filter(i => i.type === 'dimensions')
                                        .map(i => `<div style="margin-top: var(--space-1); color: var(--color-gray-600); font-size: var(--font-size-sm);">${i.message}</div>`)
                                        .join('')}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Collect unique typos
                const typoMap = new Map();
                processedBanners.forEach(banner => {
                    if (banner.typos && banner.typos.length > 0) {
                        banner.typos.forEach(typo => {
                            if (!typoMap.has(typo)) {
                                typoMap.set(typo, []);
                            }
                            typoMap.get(typo).push(banner.fileName);
                        });
                    }
                });

                if (typoMap.size > 0) {
                    html += `
                        <div class="typo-review-section">
                            <div class="category-header">
                                <span class="status-icon status-warning">⚠</span>
                                Potential Typos to Review
                            </div>
                            ${Array.from(typoMap.entries()).map(([word, files], index) => `
                                <div class="typo-item" id="typo-${index}" data-word="${word}">
                                    <div class="typo-info">
                                        <div class="typo-word">"${word}"</div>
                                        <div class="typo-occurrence">Found in ${files.length} banner${files.length > 1 ? 's' : ''}: ${files.join(', ')}</div>
                                    </div>
                                    <div class="typo-actions">
                                        <button class="btn btn-sm btn-success" onclick="approveWord('${word}', ${index})">
                                            ✓ Correct
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectWord('${word}', ${index})">
                                            ✗ Is Typo
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                issuesContainer.innerHTML = html || '<div class="no-issues">No issues found!</div>';
            }
        }

        function approveWord(word, index) {
            sessionMemory.approvedWords.add(word);
            const item = document.getElementById(`typo-${index}`);
            item.classList.add('approved');
            item.querySelector('.typo-actions').innerHTML = 
                '<span style="color: var(--color-success);">✓ Approved</span>';
        }

        function rejectWord(word, index) {
            sessionMemory.rejectedWords.add(word);
            const item = document.getElementById(`typo-${index}`);
            item.classList.add('rejected');
            item.querySelector('.typo-actions').innerHTML = 
                '<span style="color: var(--color-danger);">✗ Marked as typo</span>';
        }

        async function generatePDFReport() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Add title
            pdf.setFontSize(20);
            pdf.text('Banner Validation Report', 20, 20);
            
            pdf.setFontSize(10);
            pdf.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
            pdf.text('Malka Media Group LLC', 20, 35);
            
            // Add summary
            let y = 50;
            pdf.setFontSize(14);
            pdf.text('Summary', 20, y);
            y += 10;
            
            pdf.setFontSize(10);
            pdf.text(`Total Banners: ${processedBanners.length}`, 30, y);
            y += 7;
            pdf.text(`Passed: ${processedBanners.filter(b => !b.hasIssues && !b.error).length}`, 30, y);
            y += 7;
            pdf.text(`Issues Found: ${processedBanners.filter(b => b.hasIssues).length}`, 30, y);
            y += 15;
            
            // Add details for each banner
            pdf.setFontSize(14);
            pdf.text('Banner Details', 20, y);
            y += 10;
            
            processedBanners.forEach(banner => {
                if (y > 250) {
                    pdf.addPage();
                    y = 20;
                }
                
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text(banner.fileName, 20, y);
                pdf.setFont(undefined, 'normal');
                y += 7;
                
                pdf.setFontSize(9);
                pdf.text(`Dimensions: ${banner.width}×${banner.height}px`, 30, y);
                y += 5;
                pdf.text(`File Size: ${(banner.fileSize / 1024).toFixed(1)}KB`, 30, y);
                y += 5;
                
                if (banner.iabIssues && banner.iabIssues.length > 0) {
                    banner.iabIssues.forEach(issue => {
                        pdf.text(`• ${issue.message}`, 30, y);
                        y += 5;
                    });
                }
                
                if (sessionMemory.rejectedWords.size > 0) {
                    const bannersTypos = Array.from(sessionMemory.rejectedWords)
                        .filter(word => banner.typos?.includes(word));
                    if (bannersTypos.length > 0) {
                        pdf.text(`• Typos: ${bannersTypos.join(', ')}`, 30, y);
                        y += 5;
                    }
                }
                
                y += 5;
            });
            
            // Save PDF
            pdf.save(`banner-validation-report-${Date.now()}.pdf`);
        }

        function resetValidator() {
            uploadedFiles = [];
            processedBanners = [];
            sessionMemory = {
                approvedWords: new Set(),
                rejectedWords: new Set()
            };
            
            document.getElementById('fileQueue').innerHTML = '<div class="queue-empty">No files uploaded yet</div>';
            document.getElementById('processBtn').disabled = true;
            document.getElementById('resultsSection').classList.remove('active');
            document.getElementById('actionFooter').style.display = 'none';
            document.getElementById('fileInput').value = '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banner Batch Validator - Malka</title>
    
    <!-- Favicons from Malka Media CDN -->
    <link href="https://cdn.prod.website-files.com/63ed602b8bb6f01fe4678cd7/63f61f41d22be93246c43215_favicon-32x32.png" rel="shortcut icon" type="image/x-icon"/>
    <link href="https://cdn.prod.website-files.com/63ed602b8bb6f01fe4678cd7/63f61fc551b1bc5c6514d0a1_android-chrome-192x192.png" rel="apple-touch-icon"/>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --color-primary: #2563eb;
            --color-primary-light: #3b82f6;
            --color-success: #059669;
            --color-danger: #dc2626;
            --color-warning: #f59e0b;
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
            --font-size-xs: 0.7rem;
            --font-size-sm: 0.8rem;
            --font-size-base: 0.875rem;
            --font-size-lg: 1rem;
            --font-size-xl: 1.125rem;
            --font-size-2xl: 1.25rem;
            --space-1: 0.25rem;
            --space-2: 0.375rem;
            --space-3: 0.5rem;
            --space-4: 0.75rem;
            --space-5: 1rem;
            --space-6: 1.25rem;
            --border-radius-sm: 0.25rem;
            --border-radius: 0.375rem;
            --border-radius-lg: 0.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: var(--font-size-base);
            line-height: 1.4;
            color: var(--color-gray-800);
            background: var(--color-gray-50);
            padding: var(--space-4);
            min-height: 100vh;
        }

        .logo-container {
            max-width: 56rem;
            margin: 1rem auto 1.5rem auto;
            padding: 0;
            text-align: center;
        }

        .validator-container {
            max-width: 56rem;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--color-gray-200);
        }

        .validator-header {
            background: white;
            padding: var(--space-6) var(--space-6) var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .header-content h1 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
            letter-spacing: -0.025em;
        }

        .header-content p {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
        }

        /* Upload Section */
        .upload-section {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--color-gray-100);
        }

        .upload-area {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--color-gray-50);
            cursor: pointer;
            position: relative;
            margin-bottom: var(--space-4);
        }

        .upload-area:hover {
            border-color: var(--color-primary);
            background: #f0f9ff;
        }

        .upload-area.dragging {
            border-color: var(--color-primary);
            background: #dbeafe;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-3);
            color: var(--color-gray-400);
        }

        .upload-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
        }

        .upload-subtitle {
            color: var(--color-gray-500);
            font-size: var(--font-size-sm);
        }

        input[type="file"] {
            display: none;
        }

        .file-queue {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            max-height: 300px;
            overflow-y: auto;
        }

        .queue-title {
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--color-gray-700);
            margin-bottom: var(--space-3);
        }

        .queue-empty {
            text-align: center;
            color: var(--color-gray-400);
            padding: var(--space-6) var(--space-3);
            font-size: var(--font-size-sm);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2);
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
            border: 1px solid var(--color-gray-200);
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
        }

        .file-name {
            flex: 1;
        }

        .iab-badge {
            background: #ecfdf5;
            color: var(--color-success);
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        .status-icon {
            font-size: 1rem;
        }

        .status-pending { color: var(--color-gray-400); }
        .status-processing { color: var(--color-primary); }
        .status-complete { color: var(--color-success); }
        .status-error { color: var(--color-danger); }
        .status-warning { color: var(--color-warning); }

        /* Processing Section */
        .processing-section {
            display: none;
            padding: var(--space-6);
            text-align: center;
            border-bottom: 1px solid var(--color-gray-100);
        }

        .processing-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--space-4) 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .processing-text {
            font-size: var(--font-size-base);
            color: var(--color-gray-600);
        }

        /* Results Section */
        .results-section {
            display: none;
            padding: var(--space-5) var(--space-6);
        }

        .results-section.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .summary-card {
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-gray-200);
            text-align: center;
        }

        .summary-number {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--space-1);
        }

        .summary-label {
            font-size: var(--font-size-xs);
            color: var(--color-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-card.success .summary-number { color: var(--color-success); }
        .summary-card.warning .summary-number { color: var(--color-warning); }
        .summary-card.danger .summary-number { color: var(--color-danger); }

        /* Issues List */
        .issues-container {
            margin-top: var(--space-5);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
        }

        .issue-category {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .issue-item {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .issue-item:last-child {
            margin-bottom: 0;
        }

        .issue-banner-list {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
            margin-top: var(--space-1);
        }

        /* Typo Review with Preview */
        .typo-review-section {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            margin-top: var(--space-4);
        }

        .typo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: var(--space-3);
            border: 1px solid var(--color-warning);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .typo-item:hover {
            box-shadow: var(--shadow-md);
        }

        .typo-item.approved {
            opacity: 0.6;
            border-color: var(--color-success);
            background: #f0fdf4;
        }

        .typo-item.rejected {
            border-color: var(--color-danger);
            background: #fef2f2;
        }

        .typo-info {
            flex: 1;
        }

        .typo-word {
            font-weight: 600;
            font-size: var(--font-size-base);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .typo-occurrence {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }

        .typo-actions {
            display: flex;
            gap: var(--space-2);
        }

        /* Banner Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: var(--space-4);
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            max-width: 1200px;
            width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: var(--shadow-md);
        }

        .preview-modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-modal-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .preview-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-gray-500);
            cursor: pointer;
            padding: var(--space-2);
        }

        .preview-modal-body {
            padding: var(--space-6);
        }

        .banner-carousel {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            padding: var(--space-4) 80px;
        }

        .banner-preview-item {
            display: none;
            text-align: center;
            width: 100%;
        }

        .banner-preview-item.active {
            display: block;
        }

        .banner-preview-image {
            max-width: 100%;
            max-height: 600px;
            height: auto;
            margin: 0 auto;
            display: block;
        }

        .banner-preview-name {
            font-size: var(--font-size-base);
            color: var(--color-gray-900);
            font-weight: 400;
            margin-top: var(--space-4);
            margin-bottom: var(--space-2);
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            padding: 0 var(--space-4);
        }

        .carousel-btn {
            background: #6b7280;
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            pointer-events: all;
            padding: 0;
        }

        .carousel-btn:hover:not(:disabled) {
            background: #4b5563;
        }

        .carousel-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .carousel-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .carousel-dot.active {
            background: #111827;
        }

        .carousel-dot:hover {
            background: #6b7280;
        }

        .preview-actions {
            display: flex;
            justify-content: center;
            gap: var(--space-3);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-gray-200);
        }

        .view-banners-link {
            color: var(--color-primary);
            font-size: var(--font-size-xs);
            cursor: pointer;
            text-decoration: underline;
            margin-left: var(--space-2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-300);
        }

        .btn-sm {
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-xs);
        }

        /* Action Footer */
        .action-footer {
            padding: var(--space-5) var(--space-6);
            background: var(--color-gray-50);
            border-top: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-info {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
        }

        .footer-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-gray-300);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* No issues message */
        .no-issues {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-success);
        }

        .no-issues-icon {
            font-size: 3rem;
            margin-bottom: var(--space-3);
        }

        .no-issues-text {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .no-issues-subtext {
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
        }

        @media (max-width: 768px) {
            .upload-container {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .file-queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .total-size {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }
        
        .total-size.warning {
            color: var(--color-warning);
            font-weight: 600;
        }
        
        .total-size.error {
            color: var(--color-danger);
            font-weight: 600;
        }
        
        .zip-badge {
            background: #dbeafe;
            color: var(--color-primary);
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
            margin-left: var(--space-2);
        }
        
        .extracting-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--color-gray-300);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: var(--space-2);
        }
    </style>
</head>
<body>
    <!-- Malka Logo -->
    <div class="logo-container">
        <svg viewBox="0 0 984 200" style="width: 180px; height: auto; display: inline-block;">
            <g fill="#1f2937">
                <path d="M184.7-0.2h24.1v200h-50.5v-91.1L104.2,179L50,108.7v91.1H-0.2v-200h23.8l80.6,105L184.7-0.2z"/>
                <path d="M374.6,199.8l-15.9-35.2h-81.4l-15.6,35.2h-52.8l97-200H330l97.3,200H374.6z M317.8,73.2l-22.7,49.9h45.7L317.8,73.2z"/>
                <path d="M477,158.3h98.4v41.4H426.8v-200H477V158.3z"/>
                <path d="M677.9,99.3l89.4,100.4h-65.8l-55.9-62.1l-16.5,17.9v44.3h-48.8v-200h48.8v84.5L704-0.2h60.4L677.9,99.3z"/>
                <path d="M931.2,199.8l-15.9-35.2h-81.4l-15.6,35.2h-52.8l97-200h24.1l97.3,200H931.2z M874.5,73.2l-22.7,49.9h45.7L874.5,73.2z"/>
            </g>
        </svg>
    </div>

    <!-- Main Container -->
    <div class="validator-container">
        <!-- Header -->
        <header class="validator-header">
            <div class="header-content">
                <h1>Banner Validator & Spellcheck</h1>
                <p>Use this tool to validate banners against IAB standards and check for typos</p>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-container">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📤</div>
                    <div class="upload-title">Drop banners here</div>
                    <div class="upload-subtitle">Upload files • JPG, PNG, GIF, ZIP • 50MB total limit</div>
                    <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png,image/gif,application/zip,.zip" multiple>
                </div>
                
                <div class="file-queue">
                    <div class="file-queue-header">
                        <div class="queue-title">File Queue</div>
                        <div class="total-size" id="totalSize">0 KB / 50 MB</div>
                    </div>
                    <div id="fileQueue">
                        <div class="queue-empty">No files uploaded yet</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: var(--space-4); text-align: center;">
                <button id="processBtn" class="btn btn-primary" disabled>
                    Process Banners
                </button>
            </div>
        </section>

        <!-- Processing Section -->
        <section class="processing-section" id="processingSection">
            <div class="processing-text">
                Processing <span id="currentFile">0</span> of <span id="totalFiles">0</span> banners...
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-number" id="totalCount">0</div>
                    <div class="summary-label">Total Banners</div>
                </div>
                <div class="summary-card success">
                    <div class="summary-number" id="passCount">0</div>
                    <div class="summary-label">Passed</div>
                </div>
                <div class="summary-card warning">
                    <div class="summary-number" id="warningCount">0</div>
                    <div class="summary-label">Warnings</div>
                </div>
                <div class="summary-card danger">
                    <div class="summary-number" id="failCount">0</div>
                    <div class="summary-label">Failed</div>
                </div>
            </div>

            <div id="issuesContainer" class="issues-container">
                <!-- Issues will be dynamically inserted here -->
            </div>
        </section>

        <!-- Action Footer -->
        <div class="action-footer" id="actionFooter" style="display: none;">
            <div class="footer-info">
                Review complete
            </div>
            <div class="footer-actions">
                <button class="btn btn-outline" id="resetBtn">Start New Batch</button>
                <button class="btn btn-success" id="downloadReportBtn">📄 Download PDF Report</button>
            </div>
        </div>
    </div>

    <!-- Banner Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-modal-content">
            <div class="preview-modal-header">
                <div class="preview-modal-title" id="previewTitle">Banners containing "word"</div>
                <button class="preview-modal-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="preview-modal-body">
                <div class="banner-carousel" id="bannerCarousel">
                    <!-- Banner items will be inserted here -->
                    <div class="carousel-nav">
                        <button class="carousel-btn" id="prevBtn" onclick="navigateCarousel(-1)">◀</button>
                        <button class="carousel-btn" id="nextBtn" onclick="navigateCarousel(1)">▶</button>
                    </div>
                </div>
                <div class="carousel-dots" id="carouselDots">
                    <!-- Dots will be inserted here -->
                </div>
                <div class="preview-actions" id="previewActions">
                    <!-- Actions will be inserted here -->
                </div>
            </div>
        </div>
    </div>

<script>
    // Global state
    let uploadedFiles = [];
    let processedBanners = [];
    let sessionMemory = {
        approvedWords: new Set(),
        rejectedWords: new Set()
    };
    let pendingTypoReviews = new Set();
    let spellChecker = null;
    let currentCarouselIndex = 0;
    let currentCarouselBanners = [];
    const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB in bytes
    const MAX_INDIVIDUAL_SIZE = 10 * 1024 * 1024; // 10MB per file
    
    // IAB Specifications
    const IAB_SPECS = {
        fixedSizes: [
            { name: "Billboard", width: 970, height: 250, maxKB: 250 },
            { name: "Smartphone Banner", width: 300, height: 50, maxKB: 50 },
            { name: "Smartphone Banner", width: 320, height: 50, maxKB: 50 },
            { name: "Leaderboard", width: 728, height: 90, maxKB: 150 },
            { name: "Super Leaderboard", width: 970, height: 90, maxKB: 200 },
            { name: "Portrait", width: 300, height: 1050, maxKB: 250 },
            { name: "Monster MPU", width: 300, height: 600, maxKB: 200 },
            { name: "Skyscraper", width: 160, height: 600, maxKB: 150 },
            { name: "Medium Rectangle", width: 300, height: 250, maxKB: 150 },
            { name: "Small Banner", width: 120, height: 60, maxKB: 50 },
            { name: "Mobile Interstitial", width: 640, height: 1136, maxKB: 300 },
            { name: "Mobile Interstitial", width: 750, height: 1334, maxKB: 300 },
            { name: "Mobile Interstitial", width: 1080, height: 1920, maxKB: 300 }
        ]
    };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeSpellChecker();
        setupEventListeners();
    });
    
    async function initializeSpellChecker() {
        try {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/gh/cfinke/Typo.js@master/typo/typo.js';
            document.head.appendChild(script);
            
            await new Promise((resolve) => {
                script.onload = async () => {
                    try {
                        const [affResponse, dicResponse] = await Promise.all([
                            fetch('https://cdn.jsdelivr.net/gh/wooorm/dictionaries@main/dictionaries/en/index.aff'),
                            fetch('https://cdn.jsdelivr.net/gh/wooorm/dictionaries@main/dictionaries/en/index.dic')
                        ]);
                        
                        if (affResponse.ok && dicResponse.ok) {
                            const affData = await affResponse.text();
                            const dicData = await dicResponse.text();
                            
                            window.typoChecker = new Typo("en_US", affData, dicData);
                            console.log('Typo.js spell checker initialized with full English dictionary');
                        } else {
                            throw new Error('Failed to load dictionary files');
                        }
                    } catch (error) {
                        console.warn('Could not load full dictionary, using fallback');
                        initializeFallbackSpellChecker();
                    }
                    resolve();
                };
                script.onerror = () => {
                    console.warn('Typo.js library failed to load, using fallback');
                    initializeFallbackSpellChecker();
                    resolve();
                };
            });
            
        } catch (error) {
            console.warn('Error initializing spell checker, using fallback:', error);
            initializeFallbackSpellChecker();
        }
    
        spellChecker = {
            check: function(word) {
                const cleaned = word.toLowerCase().replace(/[^a-z]/g, '');
                
                if (cleaned.length <= 2) return true;
                if (/^\d+$/.test(word)) return true;
                
                if (sessionMemory.approvedWords.has(cleaned)) return true;
                if (sessionMemory.rejectedWords.has(cleaned)) return false;
                
                if (window.typoChecker) {
                    return window.typoChecker.check(cleaned);
                }
                
                if (window.fallbackDictionary) {
                    return window.fallbackDictionary.has(cleaned);
                }
                
                return true;
            }
        };
    }
    
    function initializeFallbackSpellChecker() {
        window.fallbackDictionary = new Set([
            'a', 'an', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as',
            'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 
            'can', 'could', 'should', 'may', 'might', 'must', 'shall', 'get', 'make', 'go', 'take', 'come', 'see',
            'know', 'think', 'look', 'want', 'give', 'use', 'find', 'tell', 'ask', 'work', 'seem', 'feel', 'try',
            'leave', 'call', 'good', 'new', 'first', 'last', 'long', 'great', 'little', 'own', 'other', 'old',
            'right', 'big', 'high', 'different', 'small', 'large', 'next', 'early', 'young', 'important', 'few',
            'public', 'bad', 'same', 'able', 'time', 'year', 'years', 'work', 'day', 'days', 'way', 'people',
            'man', 'men', 'woman', 'women', 'child', 'children', 'thing', 'things', 'life', 'world', 'hand',
            'part', 'place', 'case', 'point', 'company', 'number', 'group', 'problem', 'fact',
            'online', 'digital', 'internet', 'website', 'web', 'email', 'click', 'download', 'upload', 'share',
            'link', 'video', 'image', 'social', 'media', 'network', 'sale', 'offer', 'discount', 'price', 'shop',
            'store', 'product', 'service', 'customer', 'brand', 'quality', 'value', 'save', 'now', 'today',
            'free', 'best', 'more', 'less', 'most', 'very', 'just', 'only', 'also', 'back', 'after', 'over',
            'much', 'even', 'such', 'through', 'still', 'too', 'before', 'never', 'here', 'there', 'when',
            'where', 'how', 'all', 'both', 'each', 'every', 'any', 'some', 'that', 'this', 'these', 'those',
            'control', 'controls', 'controlled', 'controlling', 'present', 'presented', 'presenting', 'presents'
        ]);
        
        console.log('Using fallback spell checker with limited dictionary');
    }
    
    async function detectTextWithGoogleVision(imageDataUrl) {
        try {
            const base64Image = imageDataUrl.replace(/^data:image\/[a-z]+;base64,/, '');
            
            const response = await fetch('/.netlify/functions/detect-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64Image })
            });
            
            if (!response.ok) {
                console.error('Function error:', response.status);
                return { text: '', confidence: 0 };
            }
            
            const data = await response.json();
            
            if (data.responses && data.responses[0]) {
                const response = data.responses[0];
                
                if (response.fullTextAnnotation) {
                    const fullText = response.fullTextAnnotation.text;
                    console.log('Detected text:', fullText);
                    return {
                        text: fullText,
                        confidence: 85
                    };
                }
            }
            
            return { text: '', confidence: 0 };
            
        } catch (error) {
            console.error('Error calling text detection:', error);
            return { text: '', confidence: 0 };
        }
    }
    
    function setupEventListeners() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
    
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });
    
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });
    
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            handleFiles(e.dataTransfer.files);
        });
    
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
    
        processBtn.addEventListener('click', processBatch);
        resetBtn.addEventListener('click', resetValidator);
        downloadReportBtn.addEventListener('click', generatePDFReport);
    }
    
    async function handleFiles(files) {
        const fileArray = Array.from(files);
        
        for (const file of fileArray) {
            // Check if it's a zip file
            if (file.type === 'application/zip' || file.name.toLowerCase().endsWith('.zip')) {
                await extractZipFile(file);
            } else {
                // Handle individual image files
                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                    console.log('Invalid file type:', file.name);
                    continue;
                }
                if (file.size > MAX_INDIVIDUAL_SIZE) {
                    alert(`File too large: ${file.name} (max 10MB per file)`);
                    continue;
                }
                
                uploadedFiles.push({
                    file: file,
                    source: 'direct'
                });
            }
        }
        
        updateFileQueue();
    }
    
    async function extractZipFile(zipFile) {
        // Show extracting status
        const queueEl = document.getElementById('fileQueue');
        const extractingMsg = document.createElement('div');
        extractingMsg.className = 'file-item';
        extractingMsg.innerHTML = `
            <div class="file-info">
                <span class="extracting-spinner"></span>
                <span class="file-name">Extracting ${zipFile.name}...</span>
            </div>
        `;
        
        if (queueEl.querySelector('.queue-empty')) {
            queueEl.innerHTML = '';
        }
        queueEl.appendChild(extractingMsg);
        
        try {
            const zip = new JSZip();
            const contents = await zip.loadAsync(zipFile);
            
            let extractedCount = 0;
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif'];
            
            for (const [filename, zipEntry] of Object.entries(contents.files)) {
                if (zipEntry.dir) continue;
                
                const ext = filename.split('.').pop().toLowerCase();
                if (!imageExtensions.includes(ext)) continue;
                
                try {
                    const blob = await zipEntry.async('blob');
                    
                    // Determine MIME type
                    let mimeType = 'image/jpeg';
                    if (ext === 'png') mimeType = 'image/png';
                    else if (ext === 'gif') mimeType = 'image/gif';
                    
                    const file = new File([blob], filename, { type: mimeType });
                    
                    if (file.size > MAX_INDIVIDUAL_SIZE) {
                        console.log(`Skipping large file from zip: ${filename}`);
                        continue;
                    }
                    
                    uploadedFiles.push({
                        file: file,
                        source: 'zip',
                        zipName: zipFile.name
                    });
                    extractedCount++;
                    
                } catch (error) {
                    console.error(`Error extracting ${filename}:`, error);
                }
            }
            
            extractingMsg.remove();
            
            if (extractedCount === 0) {
                alert(`No valid images found in ${zipFile.name}`);
            } else {
                console.log(`Extracted ${extractedCount} images from ${zipFile.name}`);
            }
            
        } catch (error) {
            console.error('Error extracting zip:', error);
            alert(`Failed to extract ${zipFile.name}. Please ensure it's a valid zip file.`);
            extractingMsg.remove();
        }
    }
    
    function getTotalFileSize() {
        return uploadedFiles.reduce((total, item) => total + item.file.size, 0);
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 KB';
        if (bytes < 1024) return '1 KB';
        if (bytes < 1024 * 1024) return Math.ceil(bytes / 1024) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function updateFileQueue() {
        const queueEl = document.getElementById('fileQueue');
        const processBtn = document.getElementById('processBtn');
        const totalSizeEl = document.getElementById('totalSize');
        
        const totalSize = getTotalFileSize();
        const totalSizeFormatted = formatFileSize(totalSize);
        const maxSizeFormatted = formatFileSize(MAX_TOTAL_SIZE);
        
        totalSizeEl.textContent = `${totalSizeFormatted} / ${maxSizeFormatted}`;
        
        if (totalSize > MAX_TOTAL_SIZE) {
            totalSizeEl.className = 'total-size error';
            processBtn.disabled = true;
        } else if (totalSize > MAX_TOTAL_SIZE * 0.8) {
            totalSizeEl.className = 'total-size warning';
            processBtn.disabled = false;
        } else {
            totalSizeEl.className = 'total-size';
            processBtn.disabled = false;
        }
    
        if (uploadedFiles.length === 0) {
            queueEl.innerHTML = '<div class="queue-empty">No files uploaded yet</div>';
            processBtn.disabled = true;
            totalSizeEl.textContent = '0 KB / 50 MB';
            totalSizeEl.className = 'total-size';
        } else {
            queueEl.innerHTML = uploadedFiles.map((item, index) => {
                const file = item.file;
                const dimensionMatch = file.name.match(/(\d{2,4})x(\d{2,4})/);
                let iabName = '';
                
                if (dimensionMatch) {
                    const width = parseInt(dimensionMatch[1]);
                    const height = parseInt(dimensionMatch[2]);
                    const iabMatch = IAB_SPECS.fixedSizes.find(spec => 
                        spec.width === width && spec.height === height
                    );
                    if (iabMatch) {
                        iabName = `<span class="iab-badge">${iabMatch.name}</span>`;
                    }
                }
                
                const sourceTag = item.source === 'zip' 
                    ? `<span class="zip-badge" title="From ${item.zipName}">ZIP</span>` 
                    : '';
                
                return `
                    <div class="file-item" data-index="${index}">
                        <div class="file-info">
                            <span class="file-name">${file.name}</span>
                            ${iabName}
                            ${sourceTag}
                        </div>
                        <div class="file-status">
                            <span class="status-icon status-pending">✓</span>
                            <span>Ready</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (totalSize > MAX_TOTAL_SIZE) {
                processBtn.disabled = true;
                processBtn.title = 'Total file size exceeds 50MB limit';
            } else {
                processBtn.disabled = false;
                processBtn.title = '';
            }
        }
        
        if (uploadedFiles.length > 50) {
            console.warn(`Processing ${uploadedFiles.length} files - this may take a while`);
        }
    }
    
    async function processBatch() {
        if (uploadedFiles.length === 0) return;
        
        if (getTotalFileSize() > MAX_TOTAL_SIZE) {
            alert('Total file size exceeds 50MB. Please remove some files.');
            return;
        }
    
        processedBanners = [];
        sessionMemory = {
            approvedWords: new Set(),
            rejectedWords: new Set()
        };
        pendingTypoReviews = new Set();
    
        document.getElementById('processingSection').classList.add('active');
        document.getElementById('totalFiles').textContent = uploadedFiles.length;
        document.getElementById('processBtn').disabled = true;
    
        for (let i = 0; i < uploadedFiles.length; i++) {
            updateProgress(i + 1);
            updateFileStatus(i, 'processing');
            
            try {
                const result = await processImage(uploadedFiles[i].file);
                processedBanners.push(result);
                updateFileStatus(i, result.hasIssues ? 'warning' : 'complete');
            } catch (error) {
                console.error('Error processing file:', uploadedFiles[i].file.name, error);
                processedBanners.push({
                    file: uploadedFiles[i].file,
                    error: true,
                    errorMessage: error.message
                });
                updateFileStatus(i, 'error');
            }
        }
    
        displayResults();
    }
    
    function updateProgress(current) {
        document.getElementById('currentFile').textContent = current;
        const progress = (current / uploadedFiles.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }
    
    function updateFileStatus(index, status) {
        const fileItem = document.querySelector(`.file-item[data-index="${index}"]`);
        if (fileItem) {
            const statusEl = fileItem.querySelector('.file-status');
            const icons = {
                uploaded: '✓',
                processing: '<span class="spinner"></span>',
                complete: '✓',
                warning: '⚠',
                error: '✗'
            };
            statusEl.innerHTML = `
                <span class="status-icon status-${status}">${icons[status]}</span>
                <span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>
            `;
        }
    }
    
    async function processImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const img = new Image();
                
                img.onload = async () => {
                    const result = {
                        file: file,
                        fileName: file.name,
                        width: img.width,
                        height: img.height,
                        fileSize: file.size,
                        format: file.type.split('/')[1].toUpperCase(),
                        imageDataUrl: e.target.result,
                        iabIssues: [],
                        typos: [],
                        hasIssues: false,
                        detectedText: ''
                    };
    
                    const iabMatch = IAB_SPECS.fixedSizes.find(spec => 
                        spec.width === img.width && spec.height === img.height
                    );
    
                    if (iabMatch) {
                        result.iabStandard = iabMatch.name;
                        const fileSizeKB = file.size / 1024;
                        
                        if (fileSizeKB > iabMatch.maxKB) {
                            result.iabIssues.push({
                                type: 'fileSize',
                                message: `File size (${(fileSizeKB).toFixed(1)}KB) exceeds IAB limit (${iabMatch.maxKB}KB)`
                            });
                            result.hasIssues = true;
                        }
                    } else {
                        result.iabIssues.push({
                            type: 'dimensions',
                            message: `Non-standard dimensions: ${img.width}×${img.height}px`
                        });
                        result.hasIssues = true;
                    }
    
                    if (!result.iabIssues.some(issue => issue.type === 'fileSize')) {
                        try {
                            const { text, confidence } = await detectTextWithGoogleVision(e.target.result);
                            
                            if (text && confidence > 50) {
                                result.extractedText = text;
                                result.detectedText = text;
                                
                                const cleanText = text.replace(/[^\w\s]/gi, ' ');
                                const words = cleanText.toLowerCase().match(/\b[a-z]{2,}\b/g) || [];
                                const uniqueWords = [...new Set(words)];
                                
                                console.log('Unique words found:', uniqueWords);
                                
                                const brandExceptions = new Set(['youtube', 'google', 'facebook', 'instagram', 'twitter', 'tiktok', 'linkedin', 'spotify', 'netflix', 'amazon', 'www', 'com', 'org', 'net', 'http', 'https']);
                                
                                for (const word of uniqueWords) {
                                    if (!brandExceptions.has(word) &&
                                        !sessionMemory.approvedWords.has(word) && 
                                        !sessionMemory.rejectedWords.has(word) &&
                                        !spellChecker.check(word)) {
                                        result.typos.push(word);
                                        result.hasIssues = true;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Text detection error:', error);
                        }
                    }
    
                    resolve(result);
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        });
    }
    
    function displayResults() {
        document.getElementById('processingSection').classList.remove('active');
        document.getElementById('resultsSection').classList.add('active');
        document.getElementById('actionFooter').style.display = 'flex';
    
        const typoMap = new Map();
        processedBanners.forEach(banner => {
            if (banner.typos && banner.typos.length > 0) {
                banner.typos.forEach(typo => {
                    if (!typoMap.has(typo)) {
                        typoMap.set(typo, []);
                    }
                    typoMap.get(typo).push(banner.fileName);
                });
            }
        });
    
        pendingTypoReviews = new Set(typoMap.keys());
    
        const total = processedBanners.length;
        let passed = 0;
        let warnings = 0;
        let failed = 0;
    
        processedBanners.forEach(b => {
            if (b.error) {
                failed++;
            } else {
                const hasIABIssues = b.iabIssues && b.iabIssues.length > 0;
                
                const pendingTypos = (b.typos || []).filter(typo => 
                    !sessionMemory.approvedWords.has(typo) && !sessionMemory.rejectedWords.has(typo)
                );
                const confirmedTypos = (b.typos || []).filter(typo => 
                    sessionMemory.rejectedWords.has(typo)
                );
                
                if (hasIABIssues) {
                    failed++;
                } else if (pendingTypos.length > 0 || confirmedTypos.length > 0) {
                    warnings++;
                } else {
                    passed++;
                }
            }
        });
    
        document.getElementById('totalCount').textContent = total;
        document.getElementById('passCount').textContent = passed;
        document.getElementById('warningCount').textContent = warnings;
        document.getElementById('failCount').textContent = failed;
    
        const downloadBtn = document.getElementById('downloadReportBtn');
        if (pendingTypoReviews.size > 0) {
            downloadBtn.disabled = true;
            downloadBtn.title = `Review ${pendingTypoReviews.size} potential typo${pendingTypoReviews.size > 1 ? 's' : ''} before downloading report`;
        } else {
            downloadBtn.disabled = false;
            downloadBtn.title = '';
        }
    
        const issuesContainer = document.getElementById('issuesContainer');
        
        if (warnings === 0 && failed === 0) {
            issuesContainer.innerHTML = `
                <div class="no-issues">
                    <div class="no-issues-icon">✅</div>
                    <div class="no-issues-text">All banners passed validation!</div>
                    <div class="no-issues-subtext">No issues found in any of the ${total} banners.</div>
                </div>
            `;
        } else {
            let html = '';
    
            const sizeIssues = processedBanners.filter(b => 
                b.iabIssues?.some(i => i.type === 'fileSize')
            );
            
            if (sizeIssues.length > 0) {
                html += `
                    <div class="issue-category">
                        <div class="category-header">
                            <span class="status-icon status-error">✗</span>
                            File Size Issues (${sizeIssues.length})
                        </div>
                        ${sizeIssues.map(banner => `
                            <div class="issue-item">
                                <strong>${banner.fileName}</strong>
                                ${banner.iabIssues.filter(i => i.type === 'fileSize')
                                    .map(i => `<div style="margin-top: var(--space-1); color: var(--color-gray-600); font-size: var(--font-size-sm);">${i.message}</div>`)
                                    .join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
    
            const dimIssues = processedBanners.filter(b => 
                b.iabIssues?.some(i => i.type === 'dimensions')
            );
            
            if (dimIssues.length > 0) {
                html += `
                    <div class="issue-category">
                        <div class="category-header">
                            <span class="status-icon status-warning">⚠</span>
                            Dimension Issues (${dimIssues.length})
                        </div>
                        ${dimIssues.map(banner => `
                            <div class="issue-item">
                                <strong>${banner.fileName}</strong>
                                ${banner.iabIssues.filter(i => i.type === 'dimensions')
                                    .map(i => `<div style="margin-top: var(--space-1); color: var(--color-gray-600); font-size: var(--font-size-sm);">${i.message}</div>`)
                                    .join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
    
            if (typoMap.size > 0) {
                html += `
                    <div class="typo-review-section">
                        <div class="category-header">
                            <span class="status-icon status-warning">⚠</span>
                            Potential Typos to Review
                        </div>
                        ${Array.from(typoMap.entries()).map(([word, files], index) => `
                            <div class="typo-item" id="typo-${index}" data-word="${word}">
                                <div class="typo-info">
                                    <div class="typo-word">"${word}"</div>
                                    <div class="typo-occurrence">
                                        Found in ${files.length} banner${files.length > 1 ? 's' : ''}: ${files.join(', ')}
                                        <span class="view-banners-link" onclick="showBannerPreview('${word}', ${index})">View banners</span>
                                    </div>
                                </div>
                                <div class="typo-actions">
                                    <button class="btn btn-sm btn-success" onclick="approveWord('${word}', ${index})">
                                        ✓ Correct
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectWord('${word}', ${index})">
                                        ✗ Is Typo
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
    
            issuesContainer.innerHTML = html || '<div class="no-issues">No issues found!</div>';
        }
    }
    
    function approveWord(word, index) {
        sessionMemory.rejectedWords.delete(word);
        sessionMemory.approvedWords.add(word);
        pendingTypoReviews.delete(word);
        
        const item = document.getElementById(`typo-${index}`);
        item.classList.remove('rejected');
        item.classList.add('approved');
        
        const actionsDiv = item.querySelector('.typo-actions');
        actionsDiv.innerHTML = `
            <button class="btn btn-sm btn-success" onclick="approveWord('${word}', ${index})" disabled style="opacity: 1;">
                ✓ Correct
            </button>
            <button class="btn btn-sm btn-danger" onclick="rejectWord('${word}', ${index})">
                ✗ Is Typo
            </button>
        `;
        
        updateSummaryAfterReview();
    }
    
    function rejectWord(word, index) {
        sessionMemory.approvedWords.delete(word);
        sessionMemory.rejectedWords.add(word);
        pendingTypoReviews.delete(word);
        
        const item = document.getElementById(`typo-${index}`);
        item.classList.remove('approved');
        item.classList.add('rejected');
        
        const actionsDiv = item.querySelector('.typo-actions');
        actionsDiv.innerHTML = `
            <button class="btn btn-sm btn-success" onclick="approveWord('${word}', ${index})">
                ✓ Correct
            </button>
            <button class="btn btn-sm btn-danger" onclick="rejectWord('${word}', ${index})" disabled style="opacity: 1;">
                ✗ Is Typo
            </button>
        `;
        
        updateSummaryAfterReview();
    }
    
    function updateSummaryAfterReview() {
        const total = processedBanners.length;
        let passed = 0;
        let warnings = 0;
        let failed = 0;
    
        processedBanners.forEach(b => {
            if (b.error) {
                failed++;
            } else {
                const hasIABIssues = b.iabIssues && b.iabIssues.length > 0;
                
                const pendingTypos = (b.typos || []).filter(typo => 
                    !sessionMemory.approvedWords.has(typo) && !sessionMemory.rejectedWords.has(typo)
                );
                const confirmedTypos = (b.typos || []).filter(typo => 
                    sessionMemory.rejectedWords.has(typo)
                );
                
                if (hasIABIssues) {
                    failed++;
                } else if (pendingTypos.length > 0 || confirmedTypos.length > 0) {
                    warnings++;
                } else {
                    passed++;
                }
            }
        });
    
        document.getElementById('passCount').textContent = passed;
        document.getElementById('warningCount').textContent = warnings;
        document.getElementById('failCount').textContent = failed;
    
        const downloadBtn = document.getElementById('downloadReportBtn');
        if (pendingTypoReviews.size > 0) {
            downloadBtn.disabled = true;
            downloadBtn.title = `Review ${pendingTypoReviews.size} potential typo${pendingTypoReviews.size > 1 ? 's' : ''} before downloading report`;
        } else {
            downloadBtn.disabled = false;
            downloadBtn.title = '';
        }
    }
    
    async function generatePDFReport() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        pdf.setFontSize(20);
        pdf.text('Banner Validation Report', 20, 20);
        
        pdf.setFontSize(10);
        pdf.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
        pdf.text('Malka Media Group LLC', 20, 35);
        
        let y = 50;
        pdf.setFontSize(14);
        pdf.text('Summary', 20, y);
        y += 10;
        
        pdf.setFontSize(10);
        const total = processedBanners.length;
        const passed = parseInt(document.getElementById('passCount').textContent);
        const warnings = parseInt(document.getElementById('warningCount').textContent);
        const failed = parseInt(document.getElementById('failCount').textContent);
        
        pdf.text(`Total Banners: ${total}`, 30, y);
        y += 7;
        pdf.text(`Passed: ${passed}`, 30, y);
        y += 7;
        pdf.text(`Warnings: ${warnings}`, 30, y);
        y += 7;
        pdf.text(`Failed: ${failed}`, 30, y);
        y += 15;
        
        pdf.setFontSize(14);
        pdf.text('Banner Details', 20, y);
        y += 10;
        
        processedBanners.forEach(banner => {
            if (y > 250) {
                pdf.addPage();
                y = 20;
            }
            
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            
            let displayName = banner.fileName;
            if (banner.iabStandard) {
                displayName = `${banner.fileName} (${banner.iabStandard})`;
            }
            
            pdf.text(displayName, 20, y);
            pdf.setFont(undefined, 'normal');
            y += 7;
            
            pdf.setFontSize(9);
            pdf.text(`Dimensions: ${banner.width}×${banner.height}px`, 30, y);
            y += 5;
            pdf.text(`File Size: ${(banner.fileSize / 1024).toFixed(1)}KB`, 30, y);
            y += 5;
            
            if (banner.iabIssues && banner.iabIssues.length > 0) {
                banner.iabIssues.forEach(issue => {
                    pdf.text(`• ${issue.message}`, 30, y);
                    y += 5;
                });
            }
            
            const confirmedTypos = (banner.typos || []).filter(typo => 
                sessionMemory.rejectedWords.has(typo)
            );
            
            if (confirmedTypos.length > 0) {
                pdf.text(`• Confirmed Typos: ${confirmedTypos.join(', ')}`, 30, y);
                y += 5;
            }
            
            y += 5;
        });
        
        pdf.save(`banner-validation-report-${Date.now()}.pdf`);
    }
    
    function showBannerPreview(word, index) {
        const modal = document.getElementById('previewModal');
        const carousel = document.getElementById('bannerCarousel');
        const dots = document.getElementById('carouselDots');
        const title = document.getElementById('previewTitle');
        const actions = document.getElementById('previewActions');
        
        title.textContent = `Banners containing "${word}"`;
        
        const bannersWithTypo = processedBanners.filter(banner => 
            banner.typos && banner.typos.includes(word)
        );
        
        currentCarouselBanners = bannersWithTypo;
        currentCarouselIndex = 0;
        
        const bannerItemsHTML = bannersWithTypo.map((banner, idx) => `
            <div class="banner-preview-item ${idx === 0 ? 'active' : ''}" data-index="${idx}">
                <img src="${banner.imageDataUrl}" alt="${banner.fileName}" class="banner-preview-image">
                <div class="banner-preview-name">${banner.fileName}</div>
                ${banner.iabStandard ? `<div class="iab-badge" style="margin-top: 4px;">${banner.iabStandard}</div>` : ''}
                ${banner.detectedText ? `<div style="margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 4px; font-size: 11px; color: #4b5563; text-align: left;"><strong>Detected text:</strong> "${banner.detectedText.substring(0, 150)}${banner.detectedText.length > 150 ? '...' : ''}"</div>` : ''}
            </div>
        `).join('');
        
        const navButtons = carousel.querySelector('.carousel-nav');
        carousel.innerHTML = bannerItemsHTML;
        carousel.appendChild(navButtons);
        
        dots.innerHTML = bannersWithTypo.map((_, idx) => 
            `<div class="carousel-dot ${idx === 0 ? 'active' : ''}" onclick="goToSlide(${idx})"></div>`
        ).join('');
        
        updateCarouselButtons();
        
        actions.innerHTML = `
            <button class="btn btn-success" onclick="approveWordFromPreview('${word}', ${index})">
                ✓ Correct - Not a Typo
            </button>
            <button class="btn btn-danger" onclick="rejectWordFromPreview('${word}', ${index})">
                ✗ This is a Typo
            </button>
        `;
        
        modal.classList.add('active');
    }
    
    function navigateCarousel(direction) {
        const newIndex = currentCarouselIndex + direction;
        
        if (newIndex < 0 || newIndex >= currentCarouselBanners.length) {
            return;
        }
        
        goToSlide(newIndex);
    }
    
    function goToSlide(index) {
        const items = document.querySelectorAll('.banner-preview-item');
        const dots = document.querySelectorAll('.carousel-dot');
        
        items[currentCarouselIndex].classList.remove('active');
        dots[currentCarouselIndex].classList.remove('active');
        
        items[index].classList.add('active');
        dots[index].classList.add('active');
        
        currentCarouselIndex = index;
        
        updateCarouselButtons();
    }
    
    function updateCarouselButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        prevBtn.disabled = currentCarouselIndex === 0;
        nextBtn.disabled = currentCarouselIndex === currentCarouselBanners.length - 1;
    }
    
    function closePreviewModal() {
        document.getElementById('previewModal').classList.remove('active');
    }
    
    function approveWordFromPreview(word, index) {
        approveWord(word, index);
        closePreviewModal();
    }
    
    function rejectWordFromPreview(word, index) {
        rejectWord(word, index);
        closePreviewModal();
    }
    
    document.getElementById('previewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePreviewModal();
        }
    });
    
    function resetValidator() {
        uploadedFiles = [];
        processedBanners = [];
        sessionMemory = {
            approvedWords: new Set(),
            rejectedWords: new Set()
        };
        pendingTypoReviews = new Set();
        
        document.getElementById('fileQueue').innerHTML = '<div class="queue-empty">No files uploaded yet</div>';
        document.getElementById('totalSize').textContent = '0 KB / 50 MB';
        document.getElementById('totalSize').className = 'total-size';
        document.getElementById('processBtn').disabled = true;
        document.getElementById('resultsSection').classList.remove('active');
        document.getElementById('actionFooter').style.display = 'none';
        document.getElementById('fileInput').value = '';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>

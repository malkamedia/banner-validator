<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banner Batch Validator - Malka Media Group LLC</title>
    
    <!-- Favicons from Malka Media CDN -->
    <link href="https://cdn.prod.website-files.com/63ed602b8bb6f01fe4678cd7/63f61f41d22be93246c43215_favicon-32x32.png" rel="shortcut icon" type="image/x-icon"/>
    <link href="https://cdn.prod.website-files.com/63ed602b8bb6f01fe4678cd7/63f61fc551b1bc5c6514d0a1_android-chrome-192x192.png" rel="apple-touch-icon"/>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --color-primary: #2563eb;
            --color-primary-light: #3b82f6;
            --color-success: #059669;
            --color-danger: #dc2626;
            --color-warning: #f59e0b;
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
            --font-size-xs: 0.7rem;
            --font-size-sm: 0.8rem;
            --font-size-base: 0.875rem;
            --font-size-lg: 1rem;
            --font-size-xl: 1.125rem;
            --font-size-2xl: 1.25rem;
            --space-1: 0.25rem;
            --space-2: 0.375rem;
            --space-3: 0.5rem;
            --space-4: 0.75rem;
            --space-5: 1rem;
            --space-6: 1.25rem;
            --border-radius-sm: 0.25rem;
            --border-radius: 0.375rem;
            --border-radius-lg: 0.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: var(--font-size-base);
            line-height: 1.4;
            color: var(--color-gray-800);
            background: var(--color-gray-50);
            padding: var(--space-4);
            min-height: 100vh;
        }

        .logo-container {
            max-width: 56rem;
            margin: 1rem auto 1.5rem auto;
            padding: 0;
            text-align: center;
        }

        .validator-container {
            max-width: 56rem;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--color-gray-200);
        }

        .validator-header {
            background: white;
            padding: var(--space-6) var(--space-6) var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .header-content h1 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
            letter-spacing: -0.025em;
        }

        .header-content p {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
        }

        /* Upload Section */
        .upload-section {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--color-gray-100);
        }

        .upload-area {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--color-gray-50);
            cursor: pointer;
            position: relative;
            margin-bottom: var(--space-4);
        }

        .upload-area:hover {
            border-color: var(--color-primary);
            background: #f0f9ff;
        }

        .upload-area.dragging {
            border-color: var(--color-primary);
            background: #dbeafe;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-3);
            color: var(--color-gray-400);
        }

        .upload-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
        }

        .upload-subtitle {
            color: var(--color-gray-500);
            font-size: var(--font-size-sm);
        }

        input[type="file"] {
            display: none;
        }

        .file-queue {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            max-height: 300px;
            overflow-y: auto;
        }

        .queue-title {
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--color-gray-700);
            margin-bottom: var(--space-3);
        }

        .queue-empty {
            text-align: center;
            color: var(--color-gray-400);
            padding: var(--space-6) var(--space-3);
            font-size: var(--font-size-sm);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2);
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
            border: 1px solid var(--color-gray-200);
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
        }

        .file-name {
            flex: 1;
        }

        .iab-badge {
            background: #ecfdf5;
            color: var(--color-success);
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        .status-icon {
            font-size: 1rem;
        }

        .status-pending { color: var(--color-gray-400); }
        .status-processing { color: var(--color-primary); }
        .status-complete { color: var(--color-success); }
        .status-error { color: var(--color-danger); }
        .status-warning { color: var(--color-warning); }

        /* Processing Section */
        .processing-section {
            display: none;
            padding: var(--space-6);
            text-align: center;
            border-bottom: 1px solid var(--color-gray-100);
        }

        .processing-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--space-4) 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .processing-text {
            font-size: var(--font-size-base);
            color: var(--color-gray-600);
        }

        /* Results Section */
        .results-section {
            display: none;
            padding: var(--space-5) var(--space-6);
        }

        .results-section.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .summary-card {
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-gray-200);
            text-align: center;
        }

        .summary-number {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--space-1);
        }

        .summary-label {
            font-size: var(--font-size-xs);
            color: var(--color-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-card.success .summary-number { color: var(--color-success); }
        .summary-card.warning .summary-number { color: var(--color-warning); }
        .summary-card.danger .summary-number { color: var(--color-danger); }

        /* Issues List */
        .issues-container {
            margin-top: var(--space-5);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
        }

        .issue-category {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .issue-item {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .issue-item:last-child {
            margin-bottom: 0;
        }

        .issue-banner-list {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
            margin-top: var(--space-1);
        }

        /* Typo Review with Preview */
        .typo-review-section {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            margin-top: var(--space-4);
        }

        .typo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: var(--space-3);
            border: 1px solid var(--color-warning);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .typo-item:hover {
            box-shadow: var(--shadow-md);
        }

        .typo-item.approved {
            opacity: 0.6;
            border-color: var(--color-success);
            background: #f0fdf4;
        }

        .typo-item.rejected {
            border-color: var(--color-danger);
            background: #fef2f2;
        }

        .typo-info {
            flex: 1;
        }

        .typo-word {
            font-weight: 600;
            font-size: var(--font-size-base);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .typo-occurrence {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }

        .typo-actions {
            display: flex;
            gap: var(--space-2);
        }

        /* Banner Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: var(--space-4);
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: var(--shadow-md);
        }

        .preview-modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-modal-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .preview-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-gray-500);
            cursor: pointer;
            padding: var(--space-2);
        }

        .preview-modal-body {
            padding: var(--space-4);
        }

        .banner-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .banner-preview-item {
            text-align: center;
        }

        .banner-preview-image {
            width: 100%;
            height: auto;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            margin-bottom: var(--space-2);
        }

        .banner-preview-name {
            font-size: var(--font-size-xs);
            color: var(--color-gray-600);
        }

        .preview-actions {
            display: flex;
            justify-content: center;
            gap: var(--space-3);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-gray-200);
        }

        .view-banners-link {
            color: var(--color-primary);
            font-size: var(--font-size-xs);
            cursor: pointer;
            text-decoration: underline;
            margin-left: var(--space-2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-300);
        }

        .btn-sm {
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-xs);
        }

        /* Action Footer */
        .action-footer {
            padding: var(--space-5) var(--space-6);
            background: var(--color-gray-50);
            border-top: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-info {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
        }

        .footer-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-gray-300);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* No issues message */
        .no-issues {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-success);
        }

        .no-issues-icon {
            font-size: 3rem;
            margin-bottom: var(--space-3);
        }

        .no-issues-text {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .no-issues-subtext {
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
        }

        @media (max-width: 768px) {
            .upload-container {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Malka Logo -->
    <div class="logo-container">
        <svg viewBox="0 0 984 200" style="width: 180px; height: auto; display: inline-block;">
            <g fill="#1f2937">
                <path d="M184.7-0.2h24.1v200h-50.5v-91.1L104.2,179L50,108.7v91.1H-0.2v-200h23.8l80.6,105L184.7-0.2z"/>
                <path d="M374.6,199.8l-15.9-35.2h-81.4l-15.6,35.2h-52.8l97-200H330l97.3,200H374.6z M317.8,73.2l-22.7,49.9h45.7L317.8,73.2z"/>
                <path d="M477,158.3h98.4v41.4H426.8v-200H477V158.3z"/>
                <path d="M677.9,99.3l89.4,100.4h-65.8l-55.9-62.1l-16.5,17.9v44.3h-48.8v-200h48.8v84.5L704-0.2h60.4L677.9,99.3z"/>
                <path d="M931.2,199.8l-15.9-35.2h-81.4l-15.6,35.2h-52.8l97-200h24.1l97.3,200H931.2z M874.5,73.2l-22.7,49.9h45.7L874.5,73.2z"/>
            </g>
        </svg>
    </div>

    <!-- Main Container -->
    <div class="validator-container">
        <!-- Header -->
        <header class="validator-header">
            <div class="header-content">
                <h1>Banner Batch Validator</h1>
                <p>Validate multiple banners against IAB standards and check for typos</p>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-container">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ðŸ“¤</div>
                    <div class="upload-title">Drop banners here</div>
                    <div class="upload-subtitle">Upload up to 12 files â€¢ JPG, PNG, GIF</div>
                    <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png,image/gif" multiple>
                </div>
                
                <div class="file-queue">
                    <div class="queue-title">File Queue</div>
                    <div id="fileQueue">
                        <div class="queue-empty">No files uploaded yet</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: var(--space-4); text-align: center;">
                <button id="processBtn" class="btn btn-primary" disabled>
                    Process Banners
                </button>
            </div>
        </section>

        <!-- Processing Section -->
        <section class="processing-section" id="processingSection">
            <div class="processing-text">
                Processing <span id="currentFile">0</span> of <span id="totalFiles">0</span> banners...
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-number" id="totalCount">0</div>
                    <div class="summary-label">Total Banners</div>
                </div>
                <div class="summary-card success">
                    <div class="summary-number" id="passCount">0</div>
                    <div class="summary-label">Passed</div>
                </div>
                <div class="summary-card warning">
                    <div class="summary-number" id="warningCount">0</div>
                    <div class="summary-label">Warnings</div>
                </div>
                <div class="summary-card danger">
                    <div class="summary-number" id="failCount">0</div>
                    <div class="summary-label">Failed</div>
                </div>
            </div>

            <div id="issuesContainer" class="issues-container">
                <!-- Issues will be dynamically inserted here -->
            </div>
        </section>

        <!-- Action Footer -->
        <div class="action-footer" id="actionFooter" style="display: none;">
            <div class="footer-info">
                Review complete
            </div>
            <div class="footer-actions">
                <button class="btn btn-outline" id="resetBtn">Start New Batch</button>
                <button class="btn btn-success" id="downloadReportBtn">ðŸ“„ Download PDF Report</button>
            </div>
        </div>
    </div>

    <!-- Banner Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-modal-content">
            <div class="preview-modal-header">
                <div class="preview-modal-title" id="previewTitle">Banners containing "word"</div>
                <button class="preview-modal-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="preview-modal-body">
                <div class="banner-preview-grid" id="bannerPreviewGrid">
                    <!-- Banner previews will be inserted here -->
                </div>
                <div class="preview-actions" id="previewActions">
                    <!-- Actions will be inserted here -->
                </div>
            </div>
        </div>
    </div>

<script>
    // Global state
    let uploadedFiles = [];
    let processedBanners = [];
    let sessionMemory = {
        approvedWords: new Set(),
        rejectedWords: new Set()
    };
    let spellChecker = null;
    let GOOGLE_API_KEY = null;
    
    // Configuration section for API key
    function showApiKeyPrompt() {
        const existingKey = localStorage.getItem('gcv_api_key');
        if (existingKey) {
            GOOGLE_API_KEY = existingKey;
            return true;
        }
        
        const key = prompt('Please enter your Google Cloud Vision API key:\n\nIf you don\'t have one:\n1. Go to https://console.cloud.google.com\n2. Enable Cloud Vision API\n3. Create credentials (API Key)\n4. Restrict it to Cloud Vision API for security');
        
        if (key) {
            GOOGLE_API_KEY = key;
            localStorage.setItem('gcv_api_key', key);
            return true;
        }
        return false;
    }
    
    // IAB Specifications
    const IAB_SPECS = {
        fixedSizes: [
            { name: "Billboard", width: 970, height: 250, maxKB: 250 },
            { name: "Smartphone Banner", width: 300, height: 50, maxKB: 50 },
            { name: "Smartphone Banner", width: 320, height: 50, maxKB: 50 },
            { name: "Leaderboard", width: 728, height: 90, maxKB: 150 },
            { name: "Super Leaderboard", width: 970, height: 90, maxKB: 200 },
            { name: "Portrait", width: 300, height: 1050, maxKB: 250 },
            { name: "Monster MPU", width: 300, height: 600, maxKB: 200 },
            { name: "Skyscraper", width: 160, height: 600, maxKB: 150 },
            { name: "Medium Rectangle", width: 300, height: 250, maxKB: 150 },
            { name: "Small Banner", width: 120, height: 60, maxKB: 50 },
            { name: "Mobile Interstitial", width: 640, height: 1136, maxKB: 300 },
            { name: "Mobile Interstitial", width: 750, height: 1334, maxKB: 300 },
            { name: "Mobile Interstitial", width: 1080, height: 1920, maxKB: 300 }
        ]
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        // Check for API key
        if (!showApiKeyPrompt()) {
            alert('Google Cloud Vision API key is required for text detection. The tool will work for IAB validation only.');
        }
        await initializeSpellChecker();
        setupEventListeners();
    });

    async function initializeSpellChecker() {
        // Common English words dictionary
        const commonWords = new Set([
            // Articles, pronouns, prepositions
            'a', 'an', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as',
            'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'its', 'our', 'their',
            'this', 'that', 'these', 'those', 'which', 'who', 'whom', 'whose', 'what', 'when', 'where', 'why', 'how',
            // Common verbs
            'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'shall',
            'get', 'got', 'make', 'made', 'go', 'went', 'gone', 'take', 'took', 'taken', 'come', 'came', 'see', 'saw', 'seen', 'know', 'knew', 'known',
            // Common nouns
            'time', 'year', 'years', 'people', 'way', 'day', 'days', 'man', 'men', 'woman', 'women', 'thing', 'things', 'child', 'children',
            'world', 'life', 'home', 'water', 'room', 'family', 'country', 'school', 'state', 'business', 'company', 'money',
            // Common adjectives
            'good', 'new', 'first', 'last', 'long', 'great', 'little', 'own', 'other', 'old', 'right', 'big', 'high', 'different', 'small',
            'large', 'next', 'early', 'young', 'important', 'few', 'public', 'bad', 'same', 'able', 'free', 'best', 'better',
            // Technology and marketing terms
            'online', 'digital', 'internet', 'website', 'web', 'email', 'click', 'download', 'upload', 'share', 'link', 'video', 'image',
            'social', 'media', 'network', 'sale', 'offer', 'discount', 'price', 'shop', 'store', 'product', 'service', 'customer',
            'brand', 'quality', 'value', 'save', 'now', 'today', 'limited', 'exclusive', 'special', 'premium', 'professional'
        ]);

        spellChecker = {
            dictionary: commonWords,
            check: function(word) {
                const cleaned = word.toLowerCase().replace(/[^a-z]/g, '');
                if (cleaned.length <= 2) return true;
                if (/^\d+$/.test(word)) return true;
                if (sessionMemory.approvedWords.has(cleaned)) return true;
                if (sessionMemory.rejectedWords.has(cleaned)) return false;
                return this.dictionary.has(cleaned);
            }
        };
        
        console.log('Spell checker initialized with built-in dictionary');
    }

    async function detectTextWithGoogleVision(imageDataUrl) {
        if (!GOOGLE_API_KEY) {
            console.log('No API key configured, skipping text detection');
            return { text: '', confidence: 0 };
        }
        
        try {
            const base64Image = imageDataUrl.replace(/^data:image\/[a-z]+;base64,/, '');
            
            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    requests: [{
                        image: {
                            content: base64Image
                        },
                        features: [{
                            type: 'TEXT_DETECTION',
                            maxResults: 1
                        }]
                    }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                console.error('Google Vision API error:', error);
                
                if (response.status === 403 || response.status === 401) {
                    alert('Invalid or expired API key. Please refresh the page and enter a valid key.');
                    localStorage.removeItem('gcv_api_key');
                }
                return { text: '', confidence: 0 };
            }
            
            const data = await response.json();
            
            if (data.responses && data.responses[0]) {
                const response = data.responses[0];
                
                if (response.fullTextAnnotation) {
                    const fullText = response.fullTextAnnotation.text;
                    console.log('Detected text:', fullText);
                    return {
                        text: fullText,
                        confidence: 85
                    };
                }
            }
            
            return { text: '', confidence: 0 };
            
        } catch (error) {
            console.error('Error calling Google Vision API:', error);
            return { text: '', confidence: 0 };
        }
    }

    function setupEventListeners() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        processBtn.addEventListener('click', processBatch);
        resetBtn.addEventListener('click', resetValidator);
        downloadReportBtn.addEventListener('click', generatePDFReport);
    }

    function handleFiles(files) {
        const fileArray = Array.from(files);
        const validFiles = fileArray.filter(file => {
            if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                console.log('Invalid file type:', file.name);
                return false;
            }
            if (file.size > 10 * 1024 * 1024) {
                console.log('File too large:', file.name);
                return false;
            }
            return true;
        });

        if (validFiles.length === 0) {
            alert('Please upload valid image files (JPG, PNG, GIF) under 10MB');
            return;
        }

        uploadedFiles = [...uploadedFiles, ...validFiles].slice(0, 12);
        updateFileQueue();
    }

    function updateFileQueue() {
        const queueEl = document.getElementById('fileQueue');
        const processBtn = document.getElementById('processBtn');

        if (uploadedFiles.length === 0) {
            queueEl.innerHTML = '<div class="queue-empty">No files uploaded yet</div>';
            processBtn.disabled = true;
        } else {
            queueEl.innerHTML = uploadedFiles.map((file, index) => {
                const dimensionMatch = file.name.match(/(\d{2,4})x(\d{2,4})/);
                let iabName = '';
                
                if (dimensionMatch) {
                    const width = parseInt(dimensionMatch[1]);
                    const height = parseInt(dimensionMatch[2]);
                    const iabMatch = IAB_SPECS.fixedSizes.find(spec => 
                        spec.width === width && spec.height === height
                    );
                    if (iabMatch) {
                        iabName = `<span class="iab-badge">${iabMatch.name}</span>`;
                    }
                }
                
                return `
                    <div class="file-item" data-index="${index}">
                        <div class="file-info">
                            <span class="file-name">${file.name}</span>
                            ${iabName}
                        </div>
                        <div class="file-status">
                            <span class="status-icon status-pending">âœ“</span>
                            <span>Uploaded</span>
                        </div>
                    </div>
                `;
            }).join('');
            processBtn.disabled = false;
        }
    }

    async function processBatch() {
        if (uploadedFiles.length === 0) return;

        processedBanners = [];
        sessionMemory = {
            approvedWords: new Set(),
            rejectedWords: new Set()
        };

        document.getElementById('processingSection').classList.add('active');
        document.getElementById('totalFiles').textContent = uploadedFiles.length;
        document.getElementById('processBtn').disabled = true;

        for (let i = 0; i < uploadedFiles.length; i++) {
            updateProgress(i + 1);
            updateFileStatus(i, 'processing');
            
            try {
                const result = await processImage(uploadedFiles[i]);
                processedBanners.push(result);
                updateFileStatus(i, result.hasIssues ? 'warning' : 'complete');
            } catch (error) {
                console.error('Error processing file:', uploadedFiles[i].name, error);
                processedBanners.push({
                    file: uploadedFiles[i],
                    error: true,
                    errorMessage: error.message
                });
                updateFileStatus(i, 'error');
            }
        }

        displayResults();
    }

    function updateProgress(current) {
        document.getElementById('currentFile').textContent = current;
        const progress = (current / uploadedFiles.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    function updateFileStatus(index, status) {
        const fileItem = document.querySelector(`.file-item[data-index="${index}"]`);
        if (fileItem) {
            const statusEl = fileItem.querySelector('.file-status');
            const icons = {
                uploaded: 'âœ“',
                processing: '<span class="spinner"></span>',
                complete: 'âœ“',
                warning: 'âš ',
                error: 'âœ—'
            };
            statusEl.innerHTML = `
                <span class="status-icon status-${status}">${icons[status]}</span>
                <span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>
            `;
        }
    }

    async function processImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const img = new Image();
                
                img.onload = async () => {
                    const result = {
                        file: file,
                        fileName: file.name,
                        width: img.width,
                        height: img.height,
                        fileSize: file.size,
                        format: file.type.split('/')[1].toUpperCase(),
                        imageDataUrl: e.target.result,
                        iabIssues: [],
                        typos: [],
                        hasIssues: false,
                        detectedText: ''
                    };

                    const iabMatch = IAB_SPECS.fixedSizes.find(spec => 
                        spec.width === img.width && spec.height === img.height
                    );

                    if (iabMatch) {
                        result.iabStandard = iabMatch.name;
                        const fileSizeKB = file.size / 1024;
                        
                        if (fileSizeKB > iabMatch.maxKB) {
                            result.iabIssues.push({
                                type: 'fileSize',
                                message: `File size (${(fileSizeKB).toFixed(1)}KB) exceeds IAB limit (${iabMatch.maxKB}KB)`
                            });
                            result.hasIssues = true;
                        }
                    } else {
                        result.iabIssues.push({
                            type: 'dimensions',
                            message: `Non-standard dimensions: ${img.width}Ã—${img.height}px`
                        });
                        result.hasIssues = true;
                    }

                    if (!result.iabIssues.some(issue => issue.type === 'fileSize') && GOOGLE_API_KEY) {
                        try {
                            const { text, confidence } = await detectTextWithGoogleVision(e.target.result);
                            
                            if (text && confidence > 50) {
                                result.extractedText = text;
                                result.detectedText = text;
                                
                                const cleanText = text.replace(/[^\w\s]/gi, ' ');
                                const words = cleanText.toLowerCase().match(/\b[a-z]{2,}\b/g) || [];
                                const uniqueWords = [...new Set(words)];
                                
                                console.log('Unique words found:', uniqueWords);
                                
                                const brandExceptions = new Set(['youtube', 'google', 'facebook', 'instagram', 'twitter', 'tiktok', 'linkedin', 'spotify', 'netflix', 'amazon', 'www', 'com', 'org', 'net', 'http', 'https']);
                                
                                for (const word of uniqueWords) {
                                    if (!brandExceptions.has(word) &&
                                        !sessionMemory.approvedWords.has(word) && 
                                        !sessionMemory.rejectedWords.has(word) &&
                                        !spellChecker.check(word)) {
                                        result.typos.push(word);
                                        result.hasIssues = true;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Text detection error:', error);
                        }
                    }

                    resolve(result);
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        });
    }

    function displayResults() {
        document.getElementById('processingSection').classList.remove('active');
        document.getElementById('resultsSection').classList.add('active');
        document.getElementById('actionFooter').style.display = 'flex';

        const total = processedBanners.length;
        const passed = processedBanners.filter(b => !b.hasIssues && !b.error).length;
        const warnings = processedBanners.filter(b => b.hasIssues && !b.error).length;
        const failed = processedBanners.filter(b => b.error).length;

        document.getElementById('totalCount').textContent = total;
        document.getElementById('passCount').textContent = passed;
        document.getElementById('warningCount').textContent = warnings;
        document.getElementById('failCount').textContent = failed;

        const issuesContainer = document.getElementById('issuesContainer');
        
        if (warnings === 0 && failed === 0) {
            issuesContainer.innerHTML = `
                <div class="no-issues">
                    <div class="no-issues-icon">âœ…</div>
                    <div class="no-issues-text">All banners passed validation!</div>
                    <div class="no-issues-subtext">No issues found in any of the ${total} banners.</div>
                </div>
            `;
        } else {
            let html = '';

            const sizeIssues = processedBanners.filter(b => 
                b.iabIssues?.some(i => i.type === 'fileSize')
            );
            
            if (sizeIssues.length > 0) {
                html += `
                    <div class="issue-category">
                        <div class="category-header">
                            <span class="status-icon status-error">âœ—</span>
                            File Size Issues (${sizeIssues.length})
                        </div>
                        ${sizeIssues.map(banner => `
                            <div class="issue-item">
                                <strong>${banner.fileName}</strong>
                                ${banner.iabIssues.filter(i => i.type === 'fileSize')
                                    .map(i => `<div style="margin-top: var(--space-1); color: var(--color-gray-600); font-size: var(--font-size-sm);">${i.message}</div>`)
                                    .join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            const dimIssues = processedBanners.filter(b => 
                b.iabIssues?.some(i => i.type === 'dimensions')
            );
            
            if (dimIssues.length > 0) {
                html += `
                    <div class="issue-category">
                        <div class="category-header">
                            <span class="status-icon status-warning">âš </span>
                            Dimension Issues (${dimIssues.length})
                        </div>
                        ${dimIssues.map(banner => `
                            <div class="issue-item">
                                <strong>${banner.fileName}</strong>
                                ${banner.iabIssues.filter(i => i.type === 'dimensions')
                                    .map(i => `<div style="margin-top: var(--space-1); color: var(--color-gray-600); font-size: var(--font-size-sm);">${i.message}</div>`)
                                    .join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            const typoMap = new Map();
            processedBanners.forEach(banner => {
                if (banner.typos && banner.typos.length > 0) {
                    banner.typos.forEach(typo => {
                        if (!typoMap.has(typo)) {
                            typoMap.set(typo, []);
                        }
                        typoMap.get(typo).push(banner.fileName);
                    });
                }
            });

            if (typoMap.size > 0) {
                html += `
                    <div class="typo-review-section">
                        <div class="category-header">
                            <span class="status-icon status-warning">âš </span>
                            Potential Typos to Review
                        </div>
                        ${Array.from(typoMap.entries()).map(([word, files], index) => `
                            <div class="typo-item" id="typo-${index}" data-word="${word}">
                                <div class="typo-info">
                                    <div class="typo-word">"${word}"</div>
                                    <div class="typo-occurrence">
                                        Found in ${files.length} banner${files.length > 1 ? 's' : ''}: ${files.join(', ')}
                                        <span class="view-banners-link" onclick="showBannerPreview('${word}', ${index})">View banners</span>
                                    </div>
                                </div>
                                <div class="typo-actions">
                                    <button class="btn btn-sm btn-success" onclick="approveWord('${word}', ${index})">
                                        âœ“ Correct
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectWord('${word}', ${index})">
                                        âœ— Is Typo
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            issuesContainer.innerHTML = html || '<div class="no-issues">No issues found!</div>';
        }
    }

    function approveWord(word, index) {
        sessionMemory.approvedWords.add(word);
        const item = document.getElementById(`typo-${index}`);
        item.classList.add('approved');
        item.querySelector('.typo-actions').innerHTML = 
            '<span style="color: var(--color-success);">âœ“ Approved</span>';
    }

    function rejectWord(word, index) {
        sessionMemory.rejectedWords.add(word);
        const item = document.getElementById(`typo-${index}`);
        item.classList.add('rejected');
        item.querySelector('.typo-actions').innerHTML = 
            '<span style="color: var(--color-danger);">âœ— Marked as typo</span>';
    }

    async function generatePDFReport() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        pdf.setFontSize(20);
        pdf.text('Banner Validation Report', 20, 20);
        
        pdf.setFontSize(10);
        pdf.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
        pdf.text('Malka Media Group LLC', 20, 35);
        
        let y = 50;
        pdf.setFontSize(14);
        pdf.text('Summary', 20, y);
        y += 10;
        
        pdf.setFontSize(10);
        pdf.text(`Total Banners: ${processedBanners.length}`, 30, y);
        y += 7;
        pdf.text(`Passed: ${processedBanners.filter(b => !b.hasIssues && !b.error).length}`, 30, y);
        y += 7;
        pdf.text(`Issues Found: ${processedBanners.filter(b => b.hasIssues).length}`, 30, y);
        y += 15;
        
        pdf.setFontSize(14);
        pdf.text('Banner Details', 20, y);
        y += 10;
        
        processedBanners.forEach(banner => {
            if (y > 250) {
                pdf.addPage();
                y = 20;
            }
            
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            
            let displayName = banner.fileName;
            if (banner.iabStandard) {
                displayName = `${banner.fileName} (${banner.iabStandard})`;
            }
            
            pdf.text(displayName, 20, y);
            pdf.setFont(undefined, 'normal');
            y += 7;
            
            pdf.setFontSize(9);
            pdf.text(`Dimensions: ${banner.width}Ã—${banner.height}px`, 30, y);
            y += 5;
            pdf.text(`File Size: ${(banner.fileSize / 1024).toFixed(1)}KB`, 30, y);
            y += 5;
            
            if (banner.iabIssues && banner.iabIssues.length > 0) {
                banner.iabIssues.forEach(issue => {
                    pdf.text(`â€¢ ${issue.message}`, 30, y);
                    y += 5;
                });
            }
            
            if (sessionMemory.rejectedWords.size > 0) {
                const bannersTypos = Array.from(sessionMemory.rejectedWords)
                    .filter(word => banner.typos?.includes(word));
                if (bannersTypos.length > 0) {
                    pdf.text(`â€¢ Typos: ${bannersTypos.join(', ')}`, 30, y);
                    y += 5;
                }
            }
            
            y += 5;
        });
        
        pdf.save(`banner-validation-report-${Date.now()}.pdf`);
    }

    function showBannerPreview(word, index) {
        const modal = document.getElementById('previewModal');
        const grid = document.getElementById('bannerPreviewGrid');
        const title = document.getElementById('previewTitle');
        const actions = document.getElementById('previewActions');
        
        title.textContent = `Banners containing "${word}"`;
        
        const bannersWithTypo = processedBanners.filter(banner => 
            banner.typos && banner.typos.includes(word)
        );
        
        grid.innerHTML = bannersWithTypo.map(banner => `
            <div class="banner-preview-item">
                <img src="${banner.imageDataUrl}" alt="${banner.fileName}" class="banner-preview-image">
                <div class="banner-preview-name">${banner.fileName}</div>
                ${banner.iabStandard ? `<div class="iab-badge" style="margin-top: 4px;">${banner.iabStandard}</div>` : ''}
                ${banner.detectedText ? `<div style="margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 4px; font-size: 11px; color: #4b5563; text-align: left;"><strong>Detected text:</strong> "${banner.detectedText.substring(0, 100)}${banner.detectedText.length > 100 ? '...' : ''}"</div>` : ''}
            </div>
        `).join('');
        
        actions.innerHTML = `
            <button class="btn btn-success" onclick="approveWordFromPreview('${word}', ${index})">
                âœ“ Correct - Not a Typo
            </button>
            <button class="btn btn-danger" onclick="rejectWordFromPreview('${word}', ${index})">
                âœ— This is a Typo
            </button>
        `;
        
        modal.classList.add('active');
    }

    function closePreviewModal() {
        document.getElementById('previewModal').classList.remove('active');
    }

    function approveWordFromPreview(word, index) {
        approveWord(word, index);
        closePreviewModal();
    }

    function rejectWordFromPreview(word, index) {
        rejectWord(word, index);
        closePreviewModal();
    }

    document.getElementById('previewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePreviewModal();
        }
    });

    function changeApiKey() {
        localStorage.removeItem('gcv_api_key');
        if (showApiKeyPrompt()) {
            alert('API key updated successfully. You can now process a new batch.');
        }
    }

    function resetValidator() {
        uploadedFiles = [];
        processedBanners = [];
        sessionMemory = {
            approvedWords: new Set(),
            rejectedWords: new Set()
        };
        
        document.getElementById('fileQueue').innerHTML = '<div class="queue-empty">No files uploaded yet</div>';
        document.getElementById('processBtn').disabled = true;
        document.getElementById('resultsSection').classList.remove('active');
        document.getElementById('actionFooter').style.display = 'none';
        document.getElementById('fileInput').value = '';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>

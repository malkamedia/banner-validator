<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banner Batch Validator - Malka</title>
    
    <!-- Favicons from Malka Media CDN -->
    <link href="https://cdn.prod.website-files.com/63ed602b8bb6f01fe4678cd7/63f61f41d22be93246c43215_favicon-32x32.png" rel="shortcut icon" type="image/x-icon"/>
    <link href="https://cdn.prod.website-files.com/63ed602b8bb6f01fe4678cd7/63f61fc551b1bc5c6514d0a1_android-chrome-192x192.png" rel="apple-touch-icon"/>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --color-primary: #2563eb;
            --color-primary-light: #3b82f6;
            --color-success: #059669;
            --color-danger: #dc2626;
            --color-warning: #f59e0b;
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
            --font-size-xs: 0.7rem;
            --font-size-sm: 0.8rem;
            --font-size-base: 0.875rem;
            --font-size-lg: 1rem;
            --font-size-xl: 1.125rem;
            --font-size-2xl: 1.25rem;
            --space-1: 0.25rem;
            --space-2: 0.375rem;
            --space-3: 0.5rem;
            --space-4: 0.75rem;
            --space-5: 1rem;
            --space-6: 1.25rem;
            --border-radius-sm: 0.25rem;
            --border-radius: 0.375rem;
            --border-radius-lg: 0.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: var(--font-size-base);
            line-height: 1.4;
            color: var(--color-gray-800);
            background: var(--color-gray-50);
            padding: var(--space-4);
            min-height: 100vh;
        }

        .logo-container {
            max-width: 56rem;
            margin: 1rem auto 1.5rem auto;
            padding: 0;
            text-align: center;
        }

        .validator-container {
            max-width: 56rem;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--color-gray-200);
        }

        .validator-header {
            background: white;
            padding: var(--space-6) var(--space-6) var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .header-content h1 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
            letter-spacing: -0.025em;
        }

        .header-content p {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
        }

        /* Upload Section */
        .upload-section {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--color-gray-100);
        }

        .upload-area {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--color-gray-50);
            cursor: pointer;
            position: relative;
            margin-bottom: var(--space-4);
        }

        .upload-area:hover {
            border-color: var(--color-primary);
            background: #f0f9ff;
        }

        .upload-area.dragging {
            border-color: var(--color-primary);
            background: #dbeafe;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-3);
            color: var(--color-gray-400);
        }

        .upload-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
        }

        .upload-subtitle {
            color: var(--color-gray-500);
            font-size: var(--font-size-sm);
        }

        input[type="file"] {
            display: none;
        }

        .file-queue {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            max-height: 300px;
            overflow-y: auto;
        }

        .queue-title {
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--color-gray-700);
            margin-bottom: var(--space-3);
        }

        .queue-empty {
            text-align: center;
            color: var(--color-gray-400);
            padding: var(--space-6) var(--space-3);
            font-size: var(--font-size-sm);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2);
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
            border: 1px solid var(--color-gray-200);
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
        }

        .file-name {
            flex: 1;
        }

        .iab-badge {
            background: #ecfdf5;
            color: var(--color-success);
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .html5-badge {
            background: #ede9fe;
            color: #7c3aed;
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        .status-icon {
            font-size: 1rem;
        }

        .status-pending { color: var(--color-gray-400); }
        .status-processing { color: var(--color-primary); }
        .status-complete { color: var(--color-success); }
        .status-error { color: var(--color-danger); }
        .status-warning { color: var(--color-warning); }

        /* Processing Section */
        .processing-section {
            display: none;
            padding: var(--space-6);
            text-align: center;
            border-bottom: 1px solid var(--color-gray-100);
        }

        .processing-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--space-4) 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .processing-text {
            font-size: var(--font-size-base);
            color: var(--color-gray-600);
        }

        /* Results Section */
        .results-section {
            display: none;
            padding: var(--space-5) var(--space-6);
        }

        .results-section.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .summary-card {
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-gray-200);
            text-align: center;
        }

        .summary-number {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--space-1);
        }

        .summary-label {
            font-size: var(--font-size-xs);
            color: var(--color-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-card.success .summary-number { color: var(--color-success); }
        .summary-card.warning .summary-number { color: var(--color-warning); }
        .summary-card.danger .summary-number { color: var(--color-danger); }

        /* Issues List */
        .issues-container {
            margin-top: var(--space-5);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
        }

        .issue-category {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .issue-item {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .issue-item:last-child {
            margin-bottom: 0;
        }

        .issue-banner-list {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
            margin-top: var(--space-1);
        }

        .html5-issue-detail {
            margin-top: var(--space-2);
            padding-left: var(--space-3);
            border-left: 2px solid var(--color-gray-300);
        }

        .html5-issue-detail li {
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-1);
        }

        /* Accordion styles */
        .issue-accordion {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) 0;
            transition: all 0.2s ease;
        }
        
        .issue-accordion:hover {
            opacity: 0.7;
        }
        
        .accordion-caret {
            font-size: var(--font-size-sm);
            transition: transform 0.2s ease;
            color: var(--color-gray-500);
            min-width: 12px;
        }
        
        .accordion-caret.open {
            transform: rotate(90deg);
        }
        
        .accordion-summary {
            flex: 1;
            font-weight: 400;
            font-size: var(--font-size-base);
            color: var(--color-gray-900);
        }
        
        .accordion-summary.error {
            color: var(--color-danger);
        }
        
        .accordion-summary.warning {
            color: var(--color-warning);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .accordion-content.open {
            max-height: 2000px;
        }
        
        .accordion-content-inner {
            padding-left: 24px;
            padding-bottom: var(--space-2);
        }
        
        .accordion-content-inner ul {
            list-style: disc;
            padding-left: 20px;
            margin: 0;
        }
        
        .accordion-content-inner li {
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-1);
            padding-left: var(--space-1);
        }

        /* Typo Review with Preview */
        .typo-review-section {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            margin-top: var(--space-4);
        }

        .typo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: var(--space-3);
            border: 1px solid var(--color-warning);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .typo-item:hover {
            box-shadow: var(--shadow-md);
        }

        .typo-item.approved {
            opacity: 0.6;
            border-color: var(--color-success);
            background: #f0fdf4;
        }

        .typo-item.rejected {
            border-color: var(--color-danger);
            background: #fef2f2;
        }

        .typo-info {
            flex: 1;
        }

        .typo-word {
            font-weight: 600;
            font-size: var(--font-size-base);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .typo-occurrence {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }

        .typo-actions {
            display: flex;
            gap: var(--space-2);
        }

        /* Banner Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: var(--space-4);
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            max-width: 1200px;
            width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: var(--shadow-md);
        }

        .preview-modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-modal-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .preview-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-gray-500);
            cursor: pointer;
            padding: var(--space-2);
        }

        .preview-modal-body {
            padding: var(--space-6);
        }

        .banner-carousel {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            padding: var(--space-6) 80px;
        }
        
        .banner-preview-item {
            display: none;
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .banner-preview-item.active {
            display: flex;
        }

        .banner-preview-image {
            max-width: 100%;
            max-height: 600px;
            height: auto;
            margin: 0 auto;
            display: block;
        }

        .banner-preview-iframe {
            border: 1px solid var(--color-gray-300);
            background: white;
        }

        .e {
            font-size: var(--font-size-base);
            color: var(--color-gray-900);
            font-weight: 400;
            margin-top: var(--space-4);
            margin-bottom: var(--space-2);
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            padding: 0 var(--space-4);
        }

        .carousel-btn {
            background: #6b7280;
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            pointer-events: all;
            padding: 0;
        }

        .carousel-btn:hover:not(:disabled) {
            background: #4b5563;
        }

        .carousel-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .carousel-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .carousel-dot.active {
            background: #111827;
        }

        .carousel-dot:hover {
            background: #6b7280;
        }

        .preview-actions {
            display: flex;
            justify-content: center;
            gap: var(--space-3);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-gray-200);
        }

        .view-banners-link {
            color: var(--color-primary);
            font-size: var(--font-size-xs);
            cursor: pointer;
            text-decoration: underline;
            margin-left: var(--space-2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-300);
        }

        .btn-sm {
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-xs);
        }

        /* Action Footer */
        .action-footer {
            padding: var(--space-5) var(--space-6);
            background: var(--color-gray-50);
            border-top: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-info {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
        }

        .footer-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-gray-300);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* No issues message */
        .no-issues {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-success);
        }

        .no-issues-icon {
            font-size: 3rem;
            margin-bottom: var(--space-3);
        }

        .no-issues-text {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .no-issues-subtext {
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
        }

        @media (max-width: 768px) {
            .upload-container {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .file-queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .total-size {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }
        
        .total-size.warning {
            color: var(--color-warning);
            font-weight: 600;
        }
        
        .total-size.error {
            color: var(--color-danger);
            font-weight: 600;
        }
        
        .zip-badge {
            background: #dbeafe;
            color: var(--color-primary);
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
            margin-left: var(--space-2);
        }
        
        .extracting-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--color-gray-300);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: var(--space-2);
        }
       
        /* Tooltip for file paths */
        .file-name-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 125%;
            left: 0;
            background-color: #1f2937;
            color: white;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--border-radius);
            font-size: var(--font-size-xs);
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        
        .file-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 20px;
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }
        
        .file-name-wrapper:hover .file-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .zip-badge {
            background: #dbeafe;
            color: var(--color-primary);
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
            margin-left: var(--space-2);
            margin-right: var(--space-3);
        }
    </style>
</head>
<body>
    <!-- Malka Logo -->
    <div class="logo-container">
        <svg viewBox="0 0 984 200" style="width: 180px; height: auto; display: inline-block;">
            <g fill="#1f2937">
                <path d="M184.7-0.2h24.1v200h-50.5v-91.1L104.2,179L50,108.7v91.1H-0.2v-200h23.8l80.6,105L184.7-0.2z"/>
                <path d="M374.6,199.8l-15.9-35.2h-81.4l-15.6,35.2h-52.8l97-200H330l97.3,200H374.6z M317.8,73.2l-22.7,49.9h45.7L317.8,73.2z"/>
                <path d="M477,158.3h98.4v41.4H426.8v-200H477V158.3z"/>
                <path d="M677.9,99.3l89.4,100.4h-65.8l-55.9-62.1l-16.5,17.9v44.3h-48.8v-200h48.8v84.5L704-0.2h60.4L677.9,99.3z"/>
                <path d="M931.2,199.8l-15.9-35.2h-81.4l-15.6,35.2h-52.8l97-200h24.1l97.3,200H931.2z M874.5,73.2l-22.7,49.9h45.7L874.5,73.2z"/>
            </g>
        </svg>
    </div>

    <!-- Main Container -->
    <div class="validator-container">
        <!-- Header -->
        <header class="validator-header">
            <div class="header-content">
                <h1>Banner Validator & Spellcheck</h1>
                <p>Validate banners against IAB standards, Google AdWords HTML5 requirements, and check for typos</p>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-container">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ðŸ“¤</div>
                    <div class="upload-title">Drop banners here</div>
                    <div class="upload-subtitle">Upload files â€¢ JPG, PNG, GIF, ZIP (HTML5) â€¢ 50MB total limit</div>
                    <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png,image/gif,application/zip,.zip" multiple>
                </div>
                
                <div class="file-queue">
                    <div class="file-queue-header">
                        <div class="queue-title">File Queue</div>
                        <div class="total-size" id="totalSize">0 KB / 50 MB</div>
                    </div>
                    <div id="fileQueue">
                        <div class="queue-empty">No files uploaded yet</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: var(--space-4); text-align: center;">
                <button id="processBtn" class="btn btn-primary" disabled>
                    Process Banners
                </button>
            </div>
        </section>

        <!-- Processing Section -->
        <section class="processing-section" id="processingSection">
            <div class="processing-text">
                Processing <span id="currentFile">0</span> of <span id="totalFiles">0</span> banners...
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-number" id="totalCount">0</div>
                    <div class="summary-label">Total Banners</div>
                </div>
                <div class="summary-card success">
                    <div class="summary-number" id="passCount">0</div>
                    <div class="summary-label">Passed</div>
                </div>
                <div class="summary-card warning">
                    <div class="summary-number" id="warningCount">0</div>
                    <div class="summary-label">Warnings</div>
                </div>
                <div class="summary-card danger">
                    <div class="summary-number" id="failCount">0</div>
                    <div class="summary-label">Failed</div>
                </div>
            </div>

            <div id="issuesContainer" class="issues-container">
                <!-- Issues will be dynamically inserted here -->
            </div>
        </section>

        <!-- Action Footer -->
        <div class="action-footer" id="actionFooter" style="display: none;">
            <div class="footer-info">
                Review complete
            </div>
            <div class="footer-actions">
                <button class="btn btn-outline" id="resetBtn">Start New Batch</button>
                <button class="btn btn-success" id="downloadReportBtn">ðŸ“„ Download PDF Report</button>
            </div>
        </div>
    </div>

    <!-- Banner Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-modal-content">
            <div class="preview-modal-header">
                <div class="preview-modal-title" id="previewTitle">Banners containing "word"</div>
                <button class="preview-modal-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="preview-modal-body">
                <div class="banner-carousel" id="bannerCarousel">
                    <!-- Banner items will be inserted here -->
                    <div class="carousel-nav">
                        <button class="carousel-btn" id="prevBtn" onclick="navigateCarousel(-1)">â—€</button>
                        <button class="carousel-btn" id="nextBtn" onclick="navigateCarousel(1)">â–¶</button>
                    </div>
                </div>
                <div class="carousel-dots" id="carouselDots">
                    <!-- Dots will be inserted here -->
                </div>
                <div class="preview-actions" id="previewActions">
                    <!-- Actions will be inserted here -->
                </div>
            </div>
        </div>
    </div>

<script>
    // Global state
    let uploadedFiles = [];
    let processedBanners = [];
    let sessionMemory = {
        approvedWords: new Set(),
        rejectedWords: new Set()
    };
    let pendingTypoReviews = new Set();
    let spellChecker = null;
    let currentCarouselIndex = 0;
    let currentCarouselBanners = [];
    const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB in bytes
    const MAX_INDIVIDUAL_SIZE = 10 * 1024 * 1024; // 10MB per file
    
    // IAB Specifications
    const IAB_SPECS = {
        fixedSizes: [
            { name: "Billboard", width: 970, height: 250, maxKB: 250 },
            { name: "Smartphone Banner", width: 300, height: 50, maxKB: 50 },
            { name: "Smartphone Banner", width: 320, height: 50, maxKB: 50 },
            { name: "Leaderboard", width: 728, height: 90, maxKB: 150 },
            { name: "Super Leaderboard", width: 970, height: 90, maxKB: 200 },
            { name: "Portrait", width: 300, height: 1050, maxKB: 250 },
            { name: "Monster MPU", width: 300, height: 600, maxKB: 200 },
            { name: "Skyscraper", width: 160, height: 600, maxKB: 150 },
            { name: "Medium Rectangle", width: 300, height: 250, maxKB: 150 },
            { name: "Small Banner", width: 120, height: 60, maxKB: 50 },
            { name: "Mobile Interstitial", width: 640, height: 1136, maxKB: 300 },
            { name: "Mobile Interstitial", width: 750, height: 1334, maxKB: 300 },
            { name: "Mobile Interstitial", width: 1080, height: 1920, maxKB: 300 }
        ]
    };

    // HTML5 Validation - Forbidden tags per Google AdWords
    const FORBIDDEN_TAGS = ['iframe', 'frame', 'frameset', 'object', 'embed', 'audio', 'video', 'link', 'form', 'input', 'textarea', 'select', 'button'];
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeSpellChecker();
        setupEventListeners();
    });
    
    async function initializeSpellChecker() {
        try {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/gh/cfinke/Typo.js@master/typo/typo.js';
            document.head.appendChild(script);
            
            await new Promise((resolve) => {
                script.onload = async () => {
                    try {
                        const [affResponse, dicResponse] = await Promise.all([
                            fetch('https://cdn.jsdelivr.net/gh/wooorm/dictionaries@main/dictionaries/en/index.aff'),
                            fetch('https://cdn.jsdelivr.net/gh/wooorm/dictionaries@main/dictionaries/en/index.dic')
                        ]);
                        
                        if (affResponse.ok && dicResponse.ok) {
                            const affData = await affResponse.text();
                            const dicData = await dicResponse.text();
                            
                            window.typoChecker = new Typo("en_US", affData, dicData);
                            console.log('Typo.js spell checker initialized with full English dictionary');
                        } else {
                            throw new Error('Failed to load dictionary files');
                        }
                    } catch (error) {
                        console.warn('Could not load full dictionary, using fallback');
                        initializeFallbackSpellChecker();
                    }
                    resolve();
                };
                script.onerror = () => {
                    console.warn('Typo.js library failed to load, using fallback');
                    initializeFallbackSpellChecker();
                    resolve();
                };
            });
            
        } catch (error) {
            console.warn('Error initializing spell checker, using fallback:', error);
            initializeFallbackSpellChecker();
        }
    
        spellChecker = {
            check: function(word) {
                const cleaned = word.toLowerCase().replace(/[^a-z]/g, '');
                
                if (cleaned.length <= 2) return true;
                if (/^\d+$/.test(word)) return true;
                
                if (sessionMemory.approvedWords.has(cleaned)) return true;
                if (sessionMemory.rejectedWords.has(cleaned)) return false;
                
                if (window.typoChecker) {
                    return window.typoChecker.check(cleaned);
                }
                
                if (window.fallbackDictionary) {
                    return window.fallbackDictionary.has(cleaned);
                }
                
                return true;
            }
        };
    }
    
    function initializeFallbackSpellChecker() {
        window.fallbackDictionary = new Set([
            'a', 'an', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as',
            'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 
            'can', 'could', 'should', 'may', 'might', 'must', 'shall', 'get', 'make', 'go', 'take', 'come', 'see',
            'know', 'think', 'look', 'want', 'give', 'use', 'find', 'tell', 'ask', 'work', 'seem', 'feel', 'try',
            'leave', 'call', 'good', 'new', 'first', 'last', 'long', 'great', 'little', 'own', 'other', 'old',
            'right', 'big', 'high', 'different', 'small', 'large', 'next', 'early', 'young', 'important', 'few',
            'public', 'bad', 'same', 'able', 'time', 'year', 'years', 'work', 'day', 'days', 'way', 'people',
            'man', 'men', 'woman', 'women', 'child', 'children', 'thing', 'things', 'life', 'world', 'hand',
            'part', 'place', 'case', 'point', 'company', 'number', 'group', 'problem', 'fact',
            'online', 'digital', 'internet', 'website', 'web', 'email', 'click', 'download', 'upload', 'share',
            'link', 'video', 'image', 'social', 'media', 'network', 'sale', 'offer', 'discount', 'price', 'shop',
            'store', 'product', 'service', 'customer', 'brand', 'quality', 'value', 'save', 'now', 'today',
            'free', 'best', 'more', 'less', 'most', 'very', 'just', 'only', 'also', 'back', 'after', 'over',
            'much', 'even', 'such', 'through', 'still', 'too', 'before', 'never', 'here', 'there', 'when',
            'where', 'how', 'all', 'both', 'each', 'every', 'any', 'some', 'that', 'this', 'these', 'those',
            'control', 'controls', 'controlled', 'controlling', 'present', 'presented', 'presenting', 'presents'
        ]);
        
        console.log('Using fallback spell checker with limited dictionary');
    }
    
    async function detectTextWithGoogleVision(imageDataUrl) {
        try {
            const base64Image = imageDataUrl.replace(/^data:image\/[a-z]+;base64,/, '');
            
            const response = await fetch('/.netlify/functions/detect-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64Image })
            });
            
            if (!response.ok) {
                console.error('Function error:', response.status);
                return { text: '', confidence: 0, wordBoundingBoxes: [] };
            }
            
            const data = await response.json();
            
            if (data.responses && data.responses[0]) {
                const response = data.responses[0];
                
                const wordBoundingBoxes = [];
                
                if (response.textAnnotations && response.textAnnotations.length > 1) {
                    for (let i = 1; i < response.textAnnotations.length; i++) {
                        const annotation = response.textAnnotations[i];
                        wordBoundingBoxes.push({
                            word: annotation.description.toLowerCase(),
                            vertices: annotation.boundingPoly.vertices
                        });
                    }
                }
                
                if (response.fullTextAnnotation) {
                    const fullText = response.fullTextAnnotation.text;
                    console.log('Detected text:', fullText);
                    return {
                        text: fullText,
                        confidence: 85,
                        wordBoundingBoxes: wordBoundingBoxes
                    };
                }
            }
            
            return { text: '', confidence: 0, wordBoundingBoxes: [] };
            
        } catch (error) {
            console.error('Error calling text detection:', error);
            return { text: '', confidence: 0, wordBoundingBoxes: [] };
        }
    }
    
    function setupEventListeners() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
    
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });
    
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });
    
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            handleFiles(e.dataTransfer.files);
        });
    
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
    
        processBtn.addEventListener('click', processBatch);
        resetBtn.addEventListener('click', resetValidator);
        downloadReportBtn.addEventListener('click', generatePDFReport);
    }
    
    async function handleFiles(files) {
        const fileArray = Array.from(files);
        
        for (const file of fileArray) {
            if (file.type === 'application/zip' || file.name.toLowerCase().endsWith('.zip')) {
                await extractZipFile(file);
            } else {
                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                    console.log('Invalid file type:', file.name);
                    continue;
                }
                if (file.size > MAX_INDIVIDUAL_SIZE) {
                    alert(`File too large: ${file.name} (max 10MB per file)`);
                    continue;
                }
                
                uploadedFiles.push({
                    file: file,
                    source: 'direct',
                    type: 'image'
                });
            }
        }
        
        updateFileQueue();
    }
    
    async function extractZipFile(zipFile) {
        const queueEl = document.getElementById('fileQueue');
        const extractingMsg = document.createElement('div');
        extractingMsg.className = 'file-item';
        extractingMsg.innerHTML = `
            <div class="file-info">
                <span class="extracting-spinner"></span>
                <span class="file-name">Extracting ${zipFile.name}...</span>
            </div>
        `;
        
        if (queueEl.querySelector('.queue-empty')) {
            queueEl.innerHTML = '';
        }
        queueEl.appendChild(extractingMsg);
        
        try {
            const zip = new JSZip();
            const contents = await zipFile.arrayBuffer();
            await zip.loadAsync(contents);
            
            let extractedCount = 0;
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif'];
            const htmlFiles = [];
            const allFiles = {};
            
            // First pass: collect all files
            for (const [filename, zipEntry] of Object.entries(zip.files)) {
                if (zipEntry.dir) continue;
                
                const ext = filename.split('.').pop().toLowerCase();
                allFiles[filename] = zipEntry;
                
                // Check for HTML files
                if (ext === 'html' || ext === 'htm') {
                    htmlFiles.push(filename);
                }
            }
            
            // If we found HTML files, this is an HTML5 banner
            if (htmlFiles.length > 0) {
                // Find index.html or the first HTML file
                let mainHtmlFile = htmlFiles.find(f => f.toLowerCase().includes('index.html')) || htmlFiles[0];
                
                try {
                    const htmlContent = await allFiles[mainHtmlFile].async('text');
                    const htmlBlob = new Blob([htmlContent], { type: 'text/html' });
                    const htmlFile = new File([htmlBlob], mainHtmlFile, { type: 'text/html' });
                    
                    if (htmlFile.size > MAX_INDIVIDUAL_SIZE) {
                        console.log(`Skipping large HTML5 banner: ${zipFile.name}`);
                    } else {
                        uploadedFiles.push({
                            file: htmlFile,
                            source: 'zip',
                            zipName: zipFile.name,
                            type: 'html5',
                            htmlContent: htmlContent,
                            zipFiles: allFiles
                        });
                        extractedCount++;
                    }
                } catch (error) {
                    console.error(`Error extracting HTML5 banner ${mainHtmlFile}:`, error);
                }
            } else {
                // No HTML files, treat as image ZIP
                for (const [filename, zipEntry] of Object.entries(allFiles)) {
                    const ext = filename.split('.').pop().toLowerCase();
                    if (!imageExtensions.includes(ext)) continue;
                    
                    try {
                        const blob = await zipEntry.async('blob');
                        
                        let mimeType = 'image/jpeg';
                        if (ext === 'png') mimeType = 'image/png';
                        else if (ext === 'gif') mimeType = 'image/gif';
                        
                        const file = new File([blob], filename, { type: mimeType });
                        
                        if (file.size > MAX_INDIVIDUAL_SIZE) {
                            console.log(`Skipping large file from zip: ${filename}`);
                            continue;
                        }
                        
                        uploadedFiles.push({
                            file: file,
                            source: 'zip',
                            zipName: zipFile.name,
                            type: 'image'
                        });
                        extractedCount++;
                        
                    } catch (error) {
                        console.error(`Error extracting ${filename}:`, error);
                    }
                }
            }
            
            extractingMsg.remove();
            
            if (extractedCount === 0) {
                alert(`No valid banners found in ${zipFile.name}`);
            } else {
                console.log(`Extracted ${extractedCount} banner(s) from ${zipFile.name}`);
            }
            
        } catch (error) {
            console.error('Error extracting zip:', error);
            alert(`Failed to extract ${zipFile.name}. Please ensure it's a valid zip file.`);
            extractingMsg.remove();
        }
    }
    
    function getTotalFileSize() {
        return uploadedFiles.reduce((total, item) => total + item.file.size, 0);
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 KB';
        if (bytes < 1024) return '1 KB';
        if (bytes < 1024 * 1024) return Math.ceil(bytes / 1024) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function updateFileQueue() {
        const queueEl = document.getElementById('fileQueue');
        const processBtn = document.getElementById('processBtn');
        const totalSizeEl = document.getElementById('totalSize');
        
        const totalSize = getTotalFileSize();
        const totalSizeFormatted = formatFileSize(totalSize);
        const maxSizeFormatted = formatFileSize(MAX_TOTAL_SIZE);
        
        totalSizeEl.textContent = `${totalSizeFormatted} / ${maxSizeFormatted}`;
        
        if (totalSize > MAX_TOTAL_SIZE) {
            totalSizeEl.className = 'total-size error';
            processBtn.disabled = true;
        } else if (totalSize > MAX_TOTAL_SIZE * 0.8) {
            totalSizeEl.className = 'total-size warning';
            processBtn.disabled = false;
        } else {
            totalSizeEl.className = 'total-size';
            processBtn.disabled = false;
        }
    
        if (uploadedFiles.length === 0) {
            queueEl.innerHTML = '<div class="queue-empty">No files uploaded yet</div>';
            processBtn.disabled = true;
            totalSizeEl.textContent = '0 KB / 50 MB';
            totalSizeEl.className = 'total-size';
        } else {
            queueEl.innerHTML = uploadedFiles.map((item, index) => {
                const file = item.file;
                const fullPath = file.name;
                
                const displayName = fullPath.includes('/') 
                    ? fullPath.split('/').pop() 
                    : fullPath;
                
                let badges = '';
                
                if (item.type === 'html5') {
                    badges += '<span class="html5-badge">HTML5</span>';
                } else {
                    const dimensionMatch = displayName.match(/(\d{2,4})x(\d{2,4})/);
                    if (dimensionMatch) {
                        const width = parseInt(dimensionMatch[1]);
                        const height = parseInt(dimensionMatch[2]);
                        const iabMatch = IAB_SPECS.fixedSizes.find(spec => 
                            spec.width === width && spec.height === height
                        );
                        if (iabMatch) {
                            badges += `<span class="iab-badge">${iabMatch.name}</span>`;
                        }
                    }
                }
                
                const sourceTag = item.source === 'zip' 
                    ? `<span class="zip-badge" title="From ${item.zipName}">ZIP</span>` 
                    : '';
                
                const showTooltip = fullPath !== displayName;
                
                return `
                    <div class="file-item" data-index="${index}">
                        <div class="file-info">
                            <div class="file-name-wrapper">
                                <span class="file-name">${displayName}</span>
                                ${showTooltip ? `<div class="file-tooltip">${fullPath}</div>` : ''}
                            </div>
                            ${badges}
                            ${sourceTag}
                        </div>
                        <div class="file-status">
                            <span class="status-icon status-pending">âœ“</span>
                            <span>Ready</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (totalSize > MAX_TOTAL_SIZE) {
                processBtn.disabled = true;
                processBtn.title = 'Total file size exceeds 50MB limit';
            } else {
                processBtn.disabled = false;
                processBtn.title = '';
            }
        }
        
        if (uploadedFiles.length > 50) {
            console.warn(`Processing ${uploadedFiles.length} files - this may take a while`);
        }
    }
    
    async function processBatch() {
        if (uploadedFiles.length === 0) return;
        
        if (getTotalFileSize() > MAX_TOTAL_SIZE) {
            alert('Total file size exceeds 50MB. Please remove some files.');
            return;
        }
    
        processedBanners = [];
        sessionMemory = {
            approvedWords: new Set(),
            rejectedWords: new Set()
        };
        pendingTypoReviews = new Set();
    
        document.getElementById('processingSection').classList.add('active');
        document.getElementById('totalFiles').textContent = uploadedFiles.length;
        document.getElementById('processBtn').disabled = true;
    
        for (let i = 0; i < uploadedFiles.length; i++) {
            updateProgress(i + 1);
            updateFileStatus(i, 'processing');
            
            try {
                let result;
                if (uploadedFiles[i].type === 'html5') {
                    result = await processHTML5Banner(uploadedFiles[i]);
                } else {
                    result = await processImage(uploadedFiles[i].file);
                }
                processedBanners.push(result);
                updateFileStatus(i, result.hasIssues ? 'warning' : 'complete');
            } catch (error) {
                console.error('Error processing file:', uploadedFiles[i].file.name, error);
                processedBanners.push({
                    file: uploadedFiles[i].file,
                    error: true,
                    errorMessage: error.message,
                    type: uploadedFiles[i].type
                });
                updateFileStatus(i, 'error');
            }
        }
    
        displayResults();
    }
    
    function updateProgress(current) {
        document.getElementById('currentFile').textContent = current;
        const progress = (current / uploadedFiles.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }
    
    function updateFileStatus(index, status) {
        const fileItem = document.querySelector(`.file-item[data-index="${index}"]`);
        if (fileItem) {
            const statusEl = fileItem.querySelector('.file-status');
            const icons = {
                uploaded: 'âœ“',
                processing: '<span class="spinner"></span>',
                complete: 'âœ“',
                warning: 'âš ',
                error: 'âœ—'
            };
            statusEl.innerHTML = `
                <span class="status-icon status-${status}">${icons[status]}</span>
                <span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>
            `;
        }
    }

    async function processHTML5Banner(bannerData) {
        const result = {
            file: bannerData.file,
            fileName: bannerData.file.name,
            zipName: bannerData.zipName || bannerData.file.name,
            type: 'html5',
            fileSize: bannerData.file.size,
            html5Issues: [],
            hasIssues: false,
            htmlContent: bannerData.htmlContent,
            zipFiles: bannerData.zipFiles
        };

        // Validate HTML5 content
        const html = bannerData.htmlContent;
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Check for parse errors
        const parserError = doc.querySelector('parsererror');
        if (parserError) {
            result.html5Issues.push({
                type: 'structure',
                severity: 'error',
                message: 'Malformed HTML - document contains syntax errors'
            });
            result.hasIssues = true;
        }

        // Check for forbidden tags
        const foundForbiddenTags = [];
        FORBIDDEN_TAGS.forEach(tag => {
            const elements = doc.getElementsByTagName(tag);
            if (elements.length > 0) {
                foundForbiddenTags.push(tag);
            }
        });

        if (foundForbiddenTags.length > 0) {
            result.html5Issues.push({
                type: 'forbidden-tags',
                severity: 'error',
                message: `Forbidden HTML tags found: ${foundForbiddenTags.join(', ')}`,
                details: foundForbiddenTags
            });
            result.hasIssues = true;
        }

        // Check for clickTag implementation
        const hasClickTag = html.toLowerCase().includes('clicktag') || 
                           html.toLowerCase().includes('click_tag') ||
                           html.toLowerCase().includes('clickTag');
        
        if (!hasClickTag) {
            result.html5Issues.push({
                type: 'clicktag',
                severity: 'warning',
                message: 'No clickTag implementation found - required for tracking clicks'
            });
            result.hasIssues = true;
        }

        // Check for meta viewport
        const metaViewport = doc.querySelector('meta[name="viewport"]');
        if (!metaViewport) {
            result.html5Issues.push({
                type: 'viewport',
                severity: 'warning',
                message: 'Missing meta viewport tag - recommended for responsive banners'
            });
            result.hasIssues = true;
        }

        // Check for external CSS (IAB recommends inline styles)
        const externalCSS = doc.querySelectorAll('link[rel="stylesheet"]');
        if (externalCSS.length > 0) {
            result.html5Issues.push({
                type: 'css',
                severity: 'warning',
                message: `External CSS files found (${externalCSS.length}) - IAB recommends inline styles for better performance`
            });
            result.hasIssues = true;
        }

        // Check for render-blocking scripts
        const scripts = doc.querySelectorAll('script[src]');
        const blockingScripts = [];
        scripts.forEach(script => {
            if (!script.hasAttribute('async') && !script.hasAttribute('defer')) {
                blockingScripts.push(script.getAttribute('src'));
            }
        });

        if (blockingScripts.length > 0) {
            result.html5Issues.push({
                type: 'scripts',
                severity: 'warning',
                message: `Render-blocking scripts found (${blockingScripts.length}) - use async or defer attributes`,
                details: blockingScripts
            });
            result.hasIssues = true;
        }

        // Check for setTimeout/setInterval (IAB discourages for animations)
        if (html.includes('setTimeout') || html.includes('setInterval')) {
            result.html5Issues.push({
                type: 'animation',
                severity: 'warning',
                message: 'setTimeout/setInterval detected - IAB recommends requestAnimationFrame for animations'
            });
            result.hasIssues = true;
        }

        // Count file requests
        const externalResources = [
            ...doc.querySelectorAll('script[src]'),
            ...doc.querySelectorAll('link[rel="stylesheet"]'),
            ...doc.querySelectorAll('img[src]')
        ];

        if (externalResources.length > 10) {
            result.html5Issues.push({
                type: 'file-requests',
                severity: 'error',
                message: `Too many file requests (${externalResources.length}) - IAB limit is 10 for initial load`
            });
            result.hasIssues = true;
        }

        return result;
    }
    
    async function processImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const img = new Image();
                
                img.onload = async () => {
                    const result = {
                        file: file,
                        fileName: file.name,
                        type: 'image',
                        width: img.width,
                        height: img.height,
                        fileSize: file.size,
                        format: file.type.split('/')[1].toUpperCase(),
                        imageDataUrl: e.target.result,
                        iabIssues: [],
                        typos: [],
                        hasIssues: false,
                        detectedText: ''
                    };
    
                    const iabMatch = IAB_SPECS.fixedSizes.find(spec => 
                        spec.width === img.width && spec.height === img.height
                    );
    
                    if (iabMatch) {
                        result.iabStandard = iabMatch.name;
                        const fileSizeKB = file.size / 1024;
                        
                        if (fileSizeKB > iabMatch.maxKB) {
                            result.iabIssues.push({
                                type: 'fileSize',
                                message: `File size (${(fileSizeKB).toFixed(1)}KB) exceeds IAB limit (${iabMatch.maxKB}KB)`
                            });
                            result.hasIssues = true;
                        }
                    } else {
                        result.iabIssues.push({
                            type: 'dimensions',
                            message: `Non-standard dimensions: ${img.width}Ã—${img.height}px`
                        });
                        result.hasIssues = true;
                    }
    
                    if (!result.iabIssues.some(issue => issue.type === 'fileSize')) {
                        try {
                            const { text, confidence, wordBoundingBoxes } = await detectTextWithGoogleVision(e.target.result);
                            
                            if (text && confidence > 50) {
                                result.extractedText = text;
                                result.detectedText = text;
                                result.wordBoundingBoxes = wordBoundingBoxes;
                                
                                const cleanText = text.replace(/[^\w\s]/gi, ' ');
                                const words = cleanText.toLowerCase().match(/\b[a-z]{2,}\b/g) || [];
                                const uniqueWords = [...new Set(words)];
                                
                                console.log('Unique words found:', uniqueWords);
                                
                                const brandExceptions = new Set(['youtube', 'google', 'facebook', 'instagram', 'twitter', 'tiktok', 'linkedin', 'spotify', 'netflix', 'amazon', 'www', 'com', 'org', 'net', 'http', 'https']);
                                
                                for (const word of uniqueWords) {
                                    if (!brandExceptions.has(word) &&
                                        !sessionMemory.approvedWords.has(word) && 
                                        !sessionMemory.rejectedWords.has(word) &&
                                        !spellChecker.check(word)) {
                                        result.typos.push(word);
                                        result.hasIssues = true;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Text detection error:', error);
                        }
                    }
    
                    resolve(result);
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        });
    }
    
    function displayResults() {
        document.getElementById('processingSection').classList.remove('active');
        document.getElementById('resultsSection').classList.add('active');
        document.getElementById('actionFooter').style.display = 'flex';
    
        const typoMap = new Map();
        processedBanners.forEach(banner => {
            if (banner.typos && banner.typos.length > 0) {
                banner.typos.forEach(typo => {
                    if (!typoMap.has(typo)) {
                        typoMap.set(typo, []);
                    }
                    typoMap.get(typo).push(banner.fileName);
                });
            }
        });
    
        pendingTypoReviews = new Set(typoMap.keys());
    
        const total = processedBanners.length;
        let passed = 0;
        let warnings = 0;
        let failed = 0;
    
        processedBanners.forEach(b => {
            if (b.error) {
                failed++;
            } else {
                const hasIABIssues = b.iabIssues && b.iabIssues.length > 0;
                const hasHTML5Errors = b.html5Issues && b.html5Issues.some(issue => issue.severity === 'error');
                
                const pendingTypos = (b.typos || []).filter(typo => 
                    !sessionMemory.approvedWords.has(typo) && !sessionMemory.rejectedWords.has(typo)
                );
                const confirmedTypos = (b.typos || []).filter(typo => 
                    sessionMemory.rejectedWords.has(typo)
                );
                const hasHTML5Warnings = b.html5Issues && b.html5Issues.some(issue => issue.severity === 'warning');
                
                if (hasIABIssues || hasHTML5Errors) {
                    failed++;
                } else if (pendingTypos.length > 0 || confirmedTypos.length > 0 || hasHTML5Warnings) {
                    warnings++;
                } else {
                    passed++;
                }
            }
        });
    
        document.getElementById('totalCount').textContent = total;
        document.getElementById('passCount').textContent = passed;
        document.getElementById('warningCount').textContent = warnings;
        document.getElementById('failCount').textContent = failed;
    
        const downloadBtn = document.getElementById('downloadReportBtn');
        if (pendingTypoReviews.size > 0) {
            downloadBtn.disabled = true;
            downloadBtn.title = `Review ${pendingTypoReviews.size} potential typo${pendingTypoReviews.size > 1 ? 's' : ''} before downloading report`;
        } else {
            downloadBtn.disabled = false;
            downloadBtn.title = '';
        }
    
        const issuesContainer = document.getElementById('issuesContainer');
        
        if (warnings === 0 && failed === 0) {
            issuesContainer.innerHTML = `
                <div class="no-issues">
                    <div class="no-issues-icon">âœ…</div>
                    <div class="no-issues-text">All banners passed validation!</div>
                    <div class="no-issues-subtext">No issues found in any of the ${total} banners.</div>
                </div>
            `;
        } else {
            let html = '';

            // HTML5 Validation Issues (only show if HTML5 banners exist)
            const html5Banners = processedBanners.filter(b => b.type === 'html5' && b.html5Issues && b.html5Issues.length > 0);
            
            if (html5Banners.length > 0) {
                const html5Errors = html5Banners.filter(b => b.html5Issues.some(issue => issue.severity === 'error'));
                const html5Warnings = html5Banners.filter(b => b.html5Issues.some(issue => issue.severity === 'warning'));
                
                if (html5Errors.length > 0) {
                    html += `
                        <div class="issue-category">
                            <div class="category-header">
                                <span class="status-icon status-error">âœ—</span>
                                HTML5 Validation Errors (${html5Errors.length})
                            </div>
                                ${html5Errors.map((banner, idx) => {
                                const errorCount = banner.html5Issues.filter(issue => issue.severity === 'error').length;
                                const bannerIndex = processedBanners.indexOf(banner);
                                return `
                                    <div class="issue-accordion" onclick="toggleAccordion(this)">
                                        <span class="accordion-caret">â–¶</span>
                                        <strong style="margin-right: var(--space-2);">${banner.fileName}</strong>
                                        <span class="accordion-summary error">${errorCount} Critical Error${errorCount > 1 ? 's' : ''} Found</span>
                                        <span class="view-banners-link" onclick="event.stopPropagation(); showHTML5Preview(${bannerIndex})">View banner</span>
                                    </div>
                                    <div class="accordion-content">
                                        <div class="accordion-content-inner">
                                            <ul>
                                                ${banner.html5Issues
                                                    .filter(issue => issue.severity === 'error')
                                                    .map(issue => `<li>${issue.message}</li>`)
                                                    .join('')}
                                            </ul>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
                
                if (html5Warnings.length > 0) {
                    html += `
                        <div class="issue-category">
                            <div class="category-header">
                                <span class="status-icon status-warning">âš </span>
                                HTML5 Validation Warnings (${html5Warnings.length})
                            </div>
                                ${html5Warnings.map((banner, idx) => {
                                const warningCount = banner.html5Issues.filter(issue => issue.severity === 'warning').length;
                                const bannerIndex = processedBanners.indexOf(banner);
                                return `
                                    <div class="issue-accordion" onclick="toggleAccordion(this)">
                                        <span class="accordion-caret">â–¶</span>
                                        <strong style="margin-right: var(--space-2);">${banner.fileName}</strong>
                                        <span class="accordion-summary warning">${warningCount} Warning${warningCount > 1 ? 's' : ''} Found</span>
                                        <span class="view-banners-link" onclick="event.stopPropagation(); showHTML5Preview(${bannerIndex})">View banner</span>
                                    </div>
                                    <div class="accordion-content">
                                        <div class="accordion-content-inner">
                                            <ul>
                                                ${banner.html5Issues
                                                    .filter(issue => issue.severity === 'warning')
                                                    .map(issue => `<li>${issue.message}</li>`)
                                                    .join('')}
                                            </ul>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            }

            const sizeIssues = processedBanners.filter(b => 
                b.iabIssues?.some(i => i.type === 'fileSize')
            );
            
            if (sizeIssues.length > 0) {
                html += `
                    <div class="issue-category">
                        <div class="category-header">
                            <span class="status-icon status-error">âœ—</span>
                            File Size Issues (${sizeIssues.length})
                        </div>
                        ${sizeIssues.map(banner => `
                            <div class="issue-item">
                                <strong>${banner.fileName}</strong>
                                ${banner.iabIssues.filter(i => i.type === 'fileSize')
                                    .map(i => `<div style="margin-top: var(--space-1); color: var(--color-gray-600); font-size: var(--font-size-sm);">${i.message}</div>`)
                                    .join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
    
            const dimIssues = processedBanners.filter(b => 
                b.iabIssues?.some(i => i.type === 'dimensions')
            );
            
            if (dimIssues.length > 0) {
                html += `
                    <div class="issue-category">
                        <div class="category-header">
                            <span class="status-icon status-warning">âš </span>
                            Dimension Issues (${dimIssues.length})
                        </div>
                        ${dimIssues.map(banner => `
                            <div class="issue-item">
                                <strong>${banner.fileName}</strong>
                                ${banner.iabIssues.filter(i => i.type === 'dimensions')
                                    .map(i => `<div style="margin-top: var(--space-1); color: var(--color-gray-600); font-size: var(--font-size-sm);">${i.message}</div>`)
                                    .join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
    
            if (typoMap.size > 0) {
                html += `
                    <div class="typo-review-section">
                        <div class="category-header">
                            <span class="status-icon status-warning">âš </span>
                            Potential Typos to Review
                        </div>
                        ${Array.from(typoMap.entries()).map(([word, files], index) => `
                            <div class="typo-item" id="typo-${index}" data-word="${word}">
                                <div class="typo-info">
                                    <div class="typo-word">"${word}"</div>
                                    <div class="typo-occurrence">
                                        Found in ${files.length} banner${files.length > 1 ? 's' : ''}: ${files.join(', ')}
                                        <span class="view-banners-link" onclick="showBannerPreview('${word}', ${index})">View banners</span>
                                    </div>
                                </div>
                                <div class="typo-actions">
                                    <button class="btn btn-sm btn-success" onclick="approveWord('${word}', ${index})">
                                        âœ“ Correct
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectWord('${word}', ${index})">
                                        âœ— Is Typo
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
    
            issuesContainer.innerHTML = html || '<div class="no-issues">No issues found!</div>';
        }
    }
    
    function approveWord(word, index) {
        sessionMemory.rejectedWords.delete(word);
        sessionMemory.approvedWords.add(word);
        pendingTypoReviews.delete(word);
        
        const item = document.getElementById(`typo-${index}`);
        item.classList.remove('rejected');
        item.classList.add('approved');
        
        const actionsDiv = item.querySelector('.typo-actions');
        actionsDiv.innerHTML = `
            <button class="btn btn-sm btn-success" onclick="approveWord('${word}', ${index})" disabled style="opacity: 1;">
                âœ“ Correct
            </button>
            <button class="btn btn-sm btn-danger" onclick="rejectWord('${word}', ${index})">
                âœ— Is Typo
            </button>
        `;
        
        updateSummaryAfterReview();
    }
    
    function rejectWord(word, index) {
        sessionMemory.approvedWords.delete(word);
        sessionMemory.rejectedWords.add(word);
        pendingTypoReviews.delete(word);
        
        const item = document.getElementById(`typo-${index}`);
        item.classList.remove('approved');
        item.classList.add('rejected');
        
        const actionsDiv = item.querySelector('.typo-actions');
        actionsDiv.innerHTML = `
            <button class="btn btn-sm btn-success" onclick="approveWord('${word}', ${index})">
                âœ“ Correct
            </button>
            <button class="btn btn-sm btn-danger" onclick="rejectWord('${word}', ${index})" disabled style="opacity: 1;">
                âœ— Is Typo
            </button>
        `;
        
        updateSummaryAfterReview();
    }
    
    function updateSummaryAfterReview() {
        const total = processedBanners.length;
        let passed = 0;
        let warnings = 0;
        let failed = 0;
    
        processedBanners.forEach(b => {
            if (b.error) {
                failed++;
            } else {
                const hasIABIssues = b.iabIssues && b.iabIssues.length > 0;
                const hasHTML5Errors = b.html5Issues && b.html5Issues.some(issue => issue.severity === 'error');
                
                const pendingTypos = (b.typos || []).filter(typo => 
                    !sessionMemory.approvedWords.has(typo) && !sessionMemory.rejectedWords.has(typo)
                );
                const confirmedTypos = (b.typos || []).filter(typo => 
                    sessionMemory.rejectedWords.has(typo)
                );
                const hasHTML5Warnings = b.html5Issues && b.html5Issues.some(issue => issue.severity === 'warning');
                
                if (hasIABIssues || hasHTML5Errors) {
                    failed++;
                } else if (pendingTypos.length > 0 || confirmedTypos.length > 0 || hasHTML5Warnings) {
                    warnings++;
                } else {
                    passed++;
                }
            }
        });
    
        document.getElementById('passCount').textContent = passed;
        document.getElementById('warningCount').textContent = warnings;
        document.getElementById('failCount').textContent = failed;
    
        const downloadBtn = document.getElementById('downloadReportBtn');
        if (pendingTypoReviews.size > 0) {
            downloadBtn.disabled = true;
            downloadBtn.title = `Review ${pendingTypoReviews.size} potential typo${pendingTypoReviews.size > 1 ? 's' : ''} before downloading report`;
        } else {
            downloadBtn.disabled = false;
            downloadBtn.title = '';
        }
    }
    
    async function generatePDFReport() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        const colors = {
            green: [5, 150, 105],
            orange: [245, 158, 11],
            red: [220, 38, 38],
            gray: [107, 114, 128]
        };
        
        pdf.setFontSize(20);
        pdf.text('Banner Validation Report', 20, 20);
        
        pdf.setFontSize(10);
        pdf.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
        pdf.text('Malka Media Group LLC', 20, 35);
        
        let y = 50;
        pdf.setFontSize(14);
        pdf.text('Summary', 20, y);
        y += 10;
        
        pdf.setFontSize(10);
        const total = processedBanners.length;
        const passed = parseInt(document.getElementById('passCount').textContent);
        const warnings = parseInt(document.getElementById('warningCount').textContent);
        const failed = parseInt(document.getElementById('failCount').textContent);
        
        pdf.text(`Total Banners: ${total}`, 30, y);
        y += 7;
        pdf.setTextColor(...colors.green);
        pdf.text(`Passed: ${passed}`, 30, y);
        y += 7;
        pdf.setTextColor(...colors.orange);
        pdf.text(`Warnings: ${warnings}`, 30, y);
        y += 7;
        pdf.setTextColor(...colors.red);
        pdf.text(`Failed: ${failed}`, 30, y);
        y += 15;
        
        pdf.setTextColor(0, 0, 0);
        
        const categorizedBanners = {
            passed: [],
            warnings: [],
            failed: []
        };
        
        processedBanners.forEach(banner => {
            if (banner.error) {
                categorizedBanners.failed.push(banner);
            } else {
                const hasIABIssues = banner.iabIssues && banner.iabIssues.length > 0;
                const hasHTML5Errors = banner.html5Issues && banner.html5Issues.some(issue => issue.severity === 'error');
                const pendingTypos = (banner.typos || []).filter(typo => 
                    !sessionMemory.approvedWords.has(typo) && !sessionMemory.rejectedWords.has(typo)
                );
                const confirmedTypos = (banner.typos || []).filter(typo => 
                    sessionMemory.rejectedWords.has(typo)
                );
                const hasHTML5Warnings = banner.html5Issues && banner.html5Issues.some(issue => issue.severity === 'warning');
                
                if (hasIABIssues || hasHTML5Errors) {
                    categorizedBanners.failed.push(banner);
                } else if (pendingTypos.length > 0 || confirmedTypos.length > 0 || hasHTML5Warnings) {
                    categorizedBanners.warnings.push(banner);
                } else {
                    categorizedBanners.passed.push(banner);
                }
            }
        });
        
        
        function addBannerSection(title, banners, statusColor, statusText) {
            if (banners.length === 0) return;
            
            if (y > 250) {
                pdf.addPage();
                y = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(title, 20, y);
            pdf.setFont(undefined, 'normal');
            y += 10;
            
            banners.forEach(banner => {
                if (y > 250) {
                    pdf.addPage();
                    y = 20;
                }
                
                // Draw colored status box
                pdf.setFillColor(...statusColor);
                pdf.rect(20, y - 3, 4, 4, 'F');
                
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                
                let displayName = banner.fileName;
                if (banner.type === 'html5') {
                    displayName = `${banner.fileName} (HTML5)`;
                } else if (banner.iabStandard) {
                    displayName = `${banner.fileName} (${banner.iabStandard})`;
                }
                
                pdf.text(displayName, 27, y);
                pdf.setFont(undefined, 'normal');
                y += 7;
                
                pdf.setFontSize(9);
                
                if (banner.type === 'html5') {
                    pdf.text(`File Size: ${(banner.fileSize / 1024).toFixed(1)}KB`, 30, y);
                    y += 5;
                    
                    if (banner.html5Issues && banner.html5Issues.length > 0) {
                        banner.html5Issues.forEach(issue => {
                            const prefix = issue.severity === 'error' ? 'X' : '!';
                            
                            // Split long messages into multiple lines
                            const maxWidth = 150;
                            const words = issue.message.split(' ');
                            let currentLine = `${prefix} `;
                            
                            words.forEach((word, idx) => {
                                const testLine = currentLine + word + ' ';
                                const lineWidth = pdf.getTextWidth(testLine);
                                
                                if (lineWidth > maxWidth && currentLine !== `${prefix} `) {
                                    pdf.text(currentLine.trim(), 30, y);
                                    y += 5;
                                    currentLine = '  ' + word + ' ';
                                } else {
                                    currentLine = testLine;
                                }
                            });
                            
                            if (currentLine.trim().length > 0) {
                                pdf.text(currentLine.trim(), 30, y);
                                y += 5;
                            }
                            
                            // Add page break if needed
                            if (y > 250) {
                                pdf.addPage();
                                y = 20;
                            }
                        });
                    }
                } else {
                    pdf.text(`Dimensions: ${banner.width}x${banner.height}px`, 30, y);
                    y += 5;
                    pdf.text(`File Size: ${(banner.fileSize / 1024).toFixed(1)}KB`, 30, y);
                    y += 5;
                    
                    if (banner.iabIssues && banner.iabIssues.length > 0) {
                        banner.iabIssues.forEach(issue => {
                            pdf.text(`â€¢ ${issue.message}`, 30, y);
                            y += 5;
                        });
                    }
                }
                
                const confirmedTypos = (banner.typos || []).filter(typo => 
                    sessionMemory.rejectedWords.has(typo)
                );
                
                if (confirmedTypos.length > 0) {
                    pdf.text(`â€¢ Confirmed Typos: ${confirmedTypos.join(', ')}`, 30, y);
                    y += 5;
                }
                
                y += 3;
            });
            
            y += 5;
        }
        
        addBannerSection(`Passed Banners (${categorizedBanners.passed.length})`, 
                         categorizedBanners.passed, colors.green, 'PASSED');
        
        addBannerSection(`Warnings (${categorizedBanners.warnings.length})`, 
                         categorizedBanners.warnings, colors.orange, 'WARNING');
        
        addBannerSection(`Failed Banners (${categorizedBanners.failed.length})`, 
                         categorizedBanners.failed, colors.red, 'FAILED');
        
        pdf.save(`banner-validation-report-${Date.now()}.pdf`);
    }
    
    function showBannerPreview(word, index) {
        const modal = document.getElementById('previewModal');
        const carousel = document.getElementById('bannerCarousel');
        const dots = document.getElementById('carouselDots');
        const title = document.getElementById('previewTitle');
        const actions = document.getElementById('previewActions');
        
        title.textContent = `Banners containing "${word}"`;
        
        const bannersWithTypo = processedBanners.filter(banner => 
            banner.typos && banner.typos.includes(word)
        );
        
        currentCarouselBanners = bannersWithTypo;
        currentCarouselIndex = 0;
        
        const bannerItemsHTML = bannersWithTypo.map((banner, idx) => {
            if (banner.type === 'html5') {
                // HTML5 banner preview
                const displayName = banner.zipName ? banner.zipName : banner.fileName;
                return `
                    <div class="banner-preview-item ${idx === 0 ? 'active' : ''}" data-index="${idx}">
                        <iframe class="banner-preview-iframe" 
                                srcdoc="${escapeHtml(banner.htmlContent)}"
                                sandbox="allow-scripts allow-same-origin allow-popups"
                                style="width: 800px; height: 600px;"
                                scrolling="no">
                        </iframe>
                        <div class="banner-preview-name">${displayName}</div>
                        <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; font-size: 13px; color: #78350f;">
                            <strong>HTML5 Banner</strong> - Click inside to test interactions
                        </div>
                    </div>
                `;
            } else {
                // Image banner preview
                const matchingBoxes = banner.wordBoundingBoxes 
                    ? banner.wordBoundingBoxes.filter(box => box.word === word.toLowerCase())
                    : [];
                
                let svgOverlay = '';
                if (matchingBoxes.length > 0) {
                    const rects = matchingBoxes.map(box => {
                        const vertices = box.vertices;
                        const minX = Math.min(...vertices.map(v => v.x || 0));
                        const minY = Math.min(...vertices.map(v => v.y || 0));
                        const maxX = Math.max(...vertices.map(v => v.x || 0));
                        const maxY = Math.max(...vertices.map(v => v.y || 0));
                        const width = maxX - minX;
                        const height = maxY - minY;
                        
                        return `<rect x="${minX}" y="${minY}" width="${width}" height="${height}" 
                                fill="none" stroke="red" stroke-width="3" />`;
                    }).join('');
                    
                    svgOverlay = `
                        <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"
                             viewBox="0 0 ${banner.width} ${banner.height}" 
                             preserveAspectRatio="xMidYMid meet">
                            ${rects}
                        </svg>
                    `;
                }
                
                return `
                    <div class="banner-preview-item ${idx === 0 ? 'active' : ''}" data-index="${idx}">
                        <div style="position: relative; display: inline-block;">
                            <img src="${banner.imageDataUrl}" alt="${banner.fileName}" class="banner-preview-image">
                            ${svgOverlay}
                        </div>
                        <div class="banner-preview-name">${banner.fileName}</div>
                        <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; font-size: 13px; color: #78350f;">
                            <strong>Potential Typo:</strong> "${word}" (${matchingBoxes.length} occurrence${matchingBoxes.length !== 1 ? 's' : ''})
                        </div>
                    </div>
                `;
            }
        }).join('');
        
        const navButtons = carousel.querySelector('.carousel-nav');
        carousel.innerHTML = bannerItemsHTML;
        carousel.appendChild(navButtons);
        
        dots.innerHTML = bannersWithTypo.map((_, idx) => 
            `<div class="carousel-dot ${idx === 0 ? 'active' : ''}" onclick="goToSlide(${idx})"></div>`
        ).join('');
        
        // Hide carousel controls if only one banner
        if (bannersWithTypo.length === 1) {
            navButtons.style.display = 'none';
            dots.style.display = 'none';
        } else {
            navButtons.style.display = 'flex';
            dots.style.display = 'flex';
        }
        
        updateCarouselButtons();
        
        actions.innerHTML = `
            <button class="btn btn-success" onclick="approveWordFromPreview('${word}', ${index})">
                âœ“ Correct - Not a Typo
            </button>
            <button class="btn btn-danger" onclick="rejectWordFromPreview('${word}', ${index})">
                âœ— This is a Typo
            </button>
        `;
        
        modal.classList.add('active');
    }

    function showHTML5Preview(bannerIndex) {
        const banner = processedBanners[bannerIndex];
        
        if (!banner || banner.type !== 'html5') {
            console.error('Invalid HTML5 banner');
            return;
        }
        
        const modal = document.getElementById('previewModal');
        const carousel = document.getElementById('bannerCarousel');
        const dots = document.getElementById('carouselDots');
        const title = document.getElementById('previewTitle');
        const actions = document.getElementById('previewActions');
        
        const displayName = banner.zipName ? banner.zipName : banner.fileName;
        title.textContent = `HTML5 Banner Preview: ${displayName}`;
        
        currentCarouselBanners = [banner];
        currentCarouselIndex = 0;
        
        // Get dimensions from filename or HTML
        const dimensions = extractBannerDimensions(banner);
        
        // Create inline HTML with base64 encoded resources
        createInlineHTML5(banner).then(inlineHTML => {
            const bannerItemHTML = `
                <div class="banner-preview-item active" data-index="0">
                    <iframe class="banner-preview-iframe" 
                            srcdoc="${inlineHTML.replace(/"/g, '&quot;')}"
                            sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"
                            style="width: ${dimensions.width}px; height: ${dimensions.height}px;"
                            scrolling="no">
                    </iframe>
                    <div class="banner-preview-name">${displayName}</div>
                    <div style="margin-top: 12px; padding: 10px; background: #e0e7ff; border: 1px solid #6366f1; border-radius: 4px; font-size: 13px; color: #312e81;">
                        <strong>HTML5 Banner</strong> - Animations will auto-play. Click inside to test interactions.
                    </div>
                </div>
            `;
            
            const navButtons = carousel.querySelector('.carousel-nav');
            carousel.innerHTML = bannerItemHTML;
            carousel.appendChild(navButtons);
            
            dots.innerHTML = '<div class="carousel-dot active"></div>';
            
            // Hide carousel controls for single banner
            navButtons.style.display = 'none';
            dots.style.display = 'none';
            
            updateCarouselButtons();
            
            actions.innerHTML = '';
            
            modal.classList.add('active');
        });
    }

    async function createInlineHTML5(banner) {
        // Convert all files to base64 data URIs
        const fileDataURIs = {};
        
        if (banner.zipFiles) {
            for (const [filename, zipEntry] of Object.entries(banner.zipFiles)) {
                try {
                    const blob = await zipEntry.async('blob');
                    
                    // Determine correct MIME type
                    let mimeType = 'application/octet-stream';
                    const ext = filename.split('.').pop().toLowerCase();
                    
                    const mimeTypes = {
                        'png': 'image/png',
                        'jpg': 'image/jpeg',
                        'jpeg': 'image/jpeg',
                        'gif': 'image/gif',
                        'svg': 'image/svg+xml',
                        'webp': 'image/webp',
                        'js': 'text/javascript',
                        'css': 'text/css',
                        'woff': 'font/woff',
                        'woff2': 'font/woff2',
                        'ttf': 'font/ttf',
                        'otf': 'font/otf'
                    };
                    
                    mimeType = mimeTypes[ext] || mimeType;
                    
                    // Create properly typed blob
                    const typedBlob = new Blob([blob], { type: mimeType });
                    
                    // Convert to base64
                    const reader = new FileReader();
                    const base64 = await new Promise((resolve, reject) => {
                        reader.onloadend = () => {
                            // Validate base64 string
                            const result = reader.result;
                            if (result && result.startsWith('data:')) {
                                resolve(result);
                            } else {
                                reject(new Error(`Invalid base64 for ${filename}`));
                            }
                        };
                        reader.onerror = () => reject(reader.error);
                        reader.readAsDataURL(typedBlob);
                    });
                    
                    fileDataURIs[filename] = base64;
                    
                    // Also store with path variations for matching
                    const justFilename = filename.split('/').pop();
                    const withDotSlash = './' + filename;
                    
                    fileDataURIs[justFilename] = base64;
                    fileDataURIs[withDotSlash] = base64;
                    
                } catch (error) {
                    console.error(`Error creating data URI for ${filename}:`, error);
                }
            }
        }
        
        // Update HTML content to use data URIs
        let updatedHTML = banner.htmlContent;
        
        // Replace all file references with data URIs
        for (const [filename, dataURI] of Object.entries(fileDataURIs)) {
            // Skip if this is a duplicate entry (path variation)
            if (!banner.zipFiles || !banner.zipFiles[filename]) continue;
            
            // Get all possible variations of the filename
            const filenameVariations = [
                filename,
                './' + filename,
                filename.split('/').pop() // just the filename without path
            ];
            
            for (const fileVariant of filenameVariations) {
                // Escape special regex characters
                const escapedFilename = fileVariant.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                
                // 1. Google Web Designer <gwd-image source="...">
                updatedHTML = updatedHTML.replace(
                    new RegExp(`(<gwd-image[^>]*source\\s*=\\s*)(['"\`])${escapedFilename}\\2`, 'gi'),
                    `$1"${dataURI}"`
                );
                
                // 2. Standard img src="..." or src='...' or src=`...`
                updatedHTML = updatedHTML.replace(
                    new RegExp(`(<img[^>]*src\\s*=\\s*)(['"\`])${escapedFilename}\\2`, 'gi'),
                    `$1"${dataURI}"`
                );
                
                // 3. Generic src="..." (catches video, audio, etc.)
                updatedHTML = updatedHTML.replace(
                    new RegExp(`(\\ssrc\\s*=\\s*)(['"\`])${escapedFilename}\\2`, 'gi'),
                    `$1"${dataURI}"`
                );
                
                // 4. href="..." for links and stylesheets
                updatedHTML = updatedHTML.replace(
                    new RegExp(`(\\shref\\s*=\\s*)(['"\`])${escapedFilename}\\2`, 'gi'),
                    `$1"${dataURI}"`
                );
                
                // 5. CSS url() - all variations: url("..."), url('...'), url(...)
                updatedHTML = updatedHTML.replace(
                    new RegExp(`url\\(\\s*(['"\`]?)${escapedFilename}\\1\\s*\\)`, 'gi'),
                    `url("${dataURI}")`
                );
                
                // 6. xlink:href for SVG (including in style attributes)
                updatedHTML = updatedHTML.replace(
                    new RegExp(`(xlink:href\\s*=\\s*)(['"\`])${escapedFilename}\\2`, 'gi'),
                    `$1"${dataURI}"`
                );
                
                // 7. data attribute references (data-src, data-image, etc.)
                updatedHTML = updatedHTML.replace(
                    new RegExp(`(data-[a-z-]*\\s*=\\s*)(['"\`])${escapedFilename}\\2`, 'gi'),
                    `$1"${dataURI}"`
                );
                
                // 8. JavaScript string references - be careful with this one
                // Matches strings in JS like "filename" or 'filename' but not in URLs
                updatedHTML = updatedHTML.replace(
                    new RegExp(`(['"\`])${escapedFilename}\\1`, 'g'),
                    `"${dataURI}"`
                );
            }
        }
        
        return updatedHTML;
    }
    
    function extractBannerDimensions(banner) {
        // Try to extract dimensions from filename first (e.g., "300x250" or "300Ã—250")
        const filename = banner.zipName || banner.fileName;
        const filenameMatch = filename.match(/(\d{2,4})[xÃ—](\d{2,4})/i);
        
        if (filenameMatch) {
            return {
                width: parseInt(filenameMatch[1]),
                height: parseInt(filenameMatch[2])
            };
        }
        
        // Fallback: Try to extract from HTML content
        const htmlContent = banner.htmlContent;
        
        // Look for meta ad.size tag
        const metaMatch = htmlContent.match(/<meta[^>]*ad\.size[^>]*content=["']width=(\d+),\s*height=(\d+)["']/i);
        if (metaMatch) {
            return {
                width: parseInt(metaMatch[1]),
                height: parseInt(metaMatch[2])
            };
        }
        
        // Look for width and height in style
        const styleMatch = htmlContent.match(/width:\s*(\d{2,4})px[^}]*height:\s*(\d{2,4})px/i);
        if (styleMatch) {
            return {
                width: parseInt(styleMatch[1]),
                height: parseInt(styleMatch[2])
            };
        }
        
        // If we still can't find dimensions, log a warning
        console.warn('Could not extract banner dimensions from filename or HTML:', filename);
        
        // Return a common default as last resort
        return {
            width: 300,
            height: 250
        };
    }
    
    function navigateCarousel(direction) {
        const newIndex = currentCarouselIndex + direction;
        
        if (newIndex < 0 || newIndex >= currentCarouselBanners.length) {
            return;
        }
        
        goToSlide(newIndex);
    }
    
    function goToSlide(index) {
        const items = document.querySelectorAll('.banner-preview-item');
        const dots = document.querySelectorAll('.carousel-dot');
        
        items[currentCarouselIndex].classList.remove('active');
        dots[currentCarouselIndex].classList.remove('active');
        
        items[index].classList.add('active');
        dots[index].classList.add('active');
        
        currentCarouselIndex = index;
        
        updateCarouselButtons();
    }
    
    function updateCarouselButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        prevBtn.disabled = currentCarouselIndex === 0;
        nextBtn.disabled = currentCarouselIndex === currentCarouselBanners.length - 1;
    }
    
    function closePreviewModal() {
        document.getElementById('previewModal').classList.remove('active');
    }
    
    function toggleAccordion(element) {
        const caret = element.querySelector('.accordion-caret');
        const content = element.nextElementSibling;
        
        const isOpen = content.classList.contains('open');
        
        if (isOpen) {
            caret.classList.remove('open');
            content.classList.remove('open');
        } else {
            caret.classList.add('open');
            content.classList.add('open');
        }
    }
    
    function approveWordFromPreview(word, index) {
        approveWord(word, index);
        closePreviewModal();
    }
    
    function rejectWordFromPreview(word, index) {
        rejectWord(word, index);
        closePreviewModal();
    }
    
    document.getElementById('previewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePreviewModal();
        }
    });
    
    function resetValidator() {
        uploadedFiles = [];
        processedBanners = [];
        sessionMemory = {
            approvedWords: new Set(),
            rejectedWords: new Set()
        };
        pendingTypoReviews = new Set();
        
        document.getElementById('fileQueue').innerHTML = '<div class="queue-empty">No files uploaded yet</div>';
        document.getElementById('totalSize').textContent = '0 KB / 50 MB';
        document.getElementById('totalSize').className = 'total-size';
        document.getElementById('processBtn').disabled = true;
        document.getElementById('resultsSection').classList.remove('active');
        document.getElementById('actionFooter').style.display = 'none';
        document.getElementById('fileInput').value = '';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>
